---
title: ä¸€ä¸ªäº‹ä»¶å‘ç”Ÿå™¨è¦å…·å¤‡ä»€ä¹ˆ
description: ç‹¬ç«‹çš„ä½œç”¨åŸŸè®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ å®‰å…¨ï¼ŒåŒæ ·çš„è¿™ä¹Ÿè®©æ·±å±‚ä¸Šä¸‹æ–‡æ•°æ®å…±äº«æ›´éº»çƒ¦äº›ï¼Œè™½ç„¶è¿™å¾ˆå®¹æ˜“è§£å†³ã€‚ä½†åœ¨ç½‘é¡µå¼€å‘çš„ç®€å•åœºæ™¯ä¸­ï¼Œå…¨å±€çš„æ•°æ®æˆ–äº‹ä»¶æ˜¯æ›´æœ‰æ•ˆçš„å¤„ç†æ–¹å¼ã€‚
tags: JS,TS,NodeJS
badges: ç¬”è®°
publicAt: "2024-01-02"
---

åœ¨æ–‡ä»¶æ¨¡å—åŒ–çš„ä»Šå¤©ï¼Œæˆ‘ä»¬å¾ˆéš¾å†æ¥æ”¶ä¸€ä¸ªæ–‡ä»¶ä¸Šåƒè¡Œçš„ä»£ç äº†ï¼Œç‹¬ç«‹çš„ä½œç”¨åŸŸè®©æˆ‘ä»¬çš„ä»£ç æ›´åŠ å®‰å…¨ï¼ŒåŒæ ·çš„è¿™ä¹Ÿè®©æ·±å±‚ä¸Šä¸‹æ–‡æ•°æ®å…±äº«æ›´éº»çƒ¦äº›ï¼Œè™½ç„¶è¿™å¾ˆå®¹æ˜“è§£å†³ã€‚ä½†åœ¨ç½‘é¡µå¼€å‘çš„ç®€å•åœºæ™¯ä¸­ï¼Œå…¨å±€çš„æ•°æ®æˆ–äº‹ä»¶æ˜¯æ›´æœ‰æ•ˆçš„å¤„ç†æ–¹å¼ã€‚

æœ¬ç¯‡æ–‡ç« å®ç°ä¸€ä¸ªå¿…è¦åŠŸèƒ½çš„äº‹ä»¶ç®¡ç†å™¨å¯¹è±¡ã€‚

## äº‹ä»¶çš„æ ¸å¿ƒ

![Event Manager Core](/static/images/write-a-simple-event-emitter/event-manager-core.png)

- event manger: äº‹ä»¶ç®¡ç†å™¨ï¼Œæ¥è®°å½•è¢«ç»‘å®šçš„äº‹ä»¶ã€‚
- onï¼šç»‘å®šä¸”ç›‘å¬è¯¥äº‹ä»¶ï¼Œå½“äº‹ä»¶è§¦å‘åï¼Œæ‰§è¡Œç»‘å®šçš„å‡½æ•°ï¼Œä¸€ä¸ªäº‹ä»¶æ˜¯å¯ä»¥ç»‘å®šå¤šä¸ªæ‰§è¡Œå‡½æ•°çš„ï¼Œè¿™ä¹Ÿæ˜¯ äº‹ä»¶ç®¡ç†å™¨ key çš„å€¼æ˜¯å¤šä¸ª fn çš„åŸå› ã€‚
- emitï¼šäº‹ä»¶è§¦å‘ï¼Œè§¦å‘åä¼šæ‰§è¡Œå¯¹åº”äº‹ä»¶ä¸‹çš„æ‰€æœ‰ fn ã€‚äº‹ä»¶è§¦å‘å™¨å¯ä»¥ä¼ é€’å‡½æ•°å‚æ•°ï¼Œè¯¥å‚æ•°ä¼šä¼ é€’ç»™æ¯ä¸ª fnã€‚

```js
// äº‹ä»¶å‘ç”Ÿå™¨
const eventGenerator = {
  events: {},

  // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
  on(eventName, callback) {
    this.events[eventName] = this.events[eventName] || [];
    this.events[eventName].push(callback);
  },

  // è§¦å‘äº‹ä»¶
  emit(eventName, data) {
    if (this.events[eventName]) {
      this.events[eventName].forEach((callback) => callback(data));
    }
  },
};

// äº‹ä»¶æº
class User {
  constructor(name) {
    this.name = name;
  }

  login() {
    // äº§ç”Ÿç™»å½•äº‹ä»¶
    eventGenerator.emit("login", this);
  }
}

// è®¢é˜…ç™»å½•äº‹ä»¶
eventGenerator.on("login", (user) => {
  console.log(`${user.name} logged in!`);
});

// äº§ç”Ÿäº‹ä»¶
const user = new User("John");
user.login();
```

å®é™…åœ¨ dom ç¯å¢ƒå’Œ nodejs éƒ½æœ‰å†…ç½®çš„è‡ªå®šä¹‰äº‹ä»¶ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œä»–ä»¬çš„æ ¸å¿ƒæ˜¯å’Œä¸Šé¢ ğŸ‘† ä¸€æ ·çš„ï¼Œåªæ˜¯ä½¿ç”¨æ–¹å¼çš„å·®å¼‚ã€‚

- Dom: https://zh.javascript.info/dispatch-events
- NodeJS: https://nodejs.org/en/learn/asynchronous-work/the-nodejs-event-emitter
- Custom Event: https://developer.mozilla.org/en-US/docs/Web/API/CustomEvent

## ä¸šåŠ¡åŒ–

åœ¨å®é™…çš„ä¸šåŠ¡ä¸­ï¼Œäº‹ä»¶ç®¡ç†ç®¡ç†å™¨éœ€è¦åšä¸€äº›å°è£…æ¥ç®€åŒ–äº‹ä»¶çš„ç®¡ç†ï¼Œæœ€åŸºæœ¬çš„æœ‰ï¼š

- onï¼šç»‘å®šä¸”ç›‘å¬
- emitï¼šè§¦å‘
- remove/unbindï¼šè§£é™¤ç»‘å®š

æˆ‘ä»¬åŸºäºä¸Šé¢çš„ä¾‹å­å®ç°ä¸€ä¸ªåŸºæœ¬çš„åŠŸèƒ½ã€‚

```js
const eventGenerator = {
  events: {},

  // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
  on(eventName, callback) {
    this.events[eventName] = this.events[eventName] || [];
    this.events[eventName].push(callback);
  },

  // è§¦å‘äº‹ä»¶
  emit(eventName, data) {
    if(this.events[eventName]) {
      this.events[eventName].forEach(callback => callback(data));
    }
  }

  // åˆ é™¤äº‹ä»¶ç›‘å¬å™¨
  unbind(eventName, callback) {
    if (!this.events[eventName]) {
      return;
    }

    this.events[eventName] = this.events[eventName].filter(
      c => c !== callback
    );
  }
}
```

### å¢å¼ºåŠŸèƒ½

on å‡½æ•°ç»‘å®šåè¿”å›ä¸€ä¸ªå–æ¶ˆç»‘å®šäº‹ä»¶ï¼Œæ‰§è¡Œåå¯å–æ¶ˆå¯¹åº”çš„äº‹ä»¶ç»‘å®šã€‚

```js
// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
on(eventName, callback) {
  this.events[eventName] = this.events[eventName] || [];
  this.events[eventName].push(callback);

  return () => {
    this.unbind(eventName, callback);
  }
},

// example
const unbind = eventGenerator.on('login', callback);
unbind()
```

emit æ‰§è¡Œ `*` äº‹ä»¶åç§°ï¼Œä»£è¡¨è§¦å‘æ‰€æœ‰äº‹ä»¶çš„æ‰€æœ‰å‡½æ•°ã€‚

```js
// è§¦å‘å…¨éƒ¨
emitAll(data) {
  Object.keys(this.events).forEach(eventName => {
    if(this.events[eventName]) {
      this.events[eventName].forEach(callback => {
        callback(data);
      });
    }
  });
},

// è§¦å‘äº‹ä»¶
emit(eventName, data) {
  if(eventName === '*') {
    this.emitAll(data)
  } else if(this.events[eventName]) {
    this.events[eventName].forEach(callback => callback(data));
  }
}

// example
eventGenerator.on('login', callback1);
eventGenerator.on('logout', callback2);

eventGenerator.emit("*", user)
```

once åªç›‘å¬ä¸€æ¬¡è¯¥äº‹ä»¶ã€‚

```js
once(eventName, callback) {
  const unbind = this.on(eventName, (data) => {
    unbind();
    callback(data);
  })
  // å¯ç”¨äºåœ¨å‡½æ•°æœªæ‰§è¡Œå‰ï¼Œè§£é™¤ç»‘å®š
  return unbind();
}

// example
eventGenerator.once('login', callback1);
```

å®Œæ•´çš„ä»£ç 

```js
const eventGenerator = {
  events: {},

  // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
  on(eventName, callback) {
	this.events[eventName] = this.events[eventName] || [];
	this.events[eventName].push(callback);

	return () => {
	  this.unbind(eventName, callback);
    }
  },

  // åªç›‘å¬ä¸€æ¬¡
  once(eventName, callback) {
	const unbind = this.on(eventName, (data) => {
	  unbind();
	  callback(data);
	})
	// å¯ç”¨äºåœ¨å‡½æ•°æœªæ‰§è¡Œå‰ï¼Œè§£é™¤ç»‘å®š
	return unbind();
  }

  // è§¦å‘å…¨éƒ¨
  emitAll(data) {
	Object.keys(this.events).forEach(eventName => {
	  if(this.events[eventName]) {
	    this.events[eventName].forEach(callback => {
	      callback(data);
	    });
	   }
    });
  },

  // è§¦å‘äº‹ä»¶
  emit(eventName, data) {
    if(eventName === '*') {
      this.emitAll(data)
	} else if(this.events[eventName]) {
      this.events[eventName].forEach(callback => callback(data));
    }
  }

  // åˆ é™¤äº‹ä»¶ç›‘å¬å™¨
  unbind(eventName, callback) {
    if (!this.events[eventName]) {
      return;
    }

	// callback ä¸€å®šè¦æ˜¯åŸæœ‰å¼•ç”¨ï¼Œè¿™é‡Œæ˜¯å¼•ç”¨æ¯”è¾ƒ
    this.events[eventName] = this.events[eventName].filter(
      c => c !== callback
    );
  }
}
```

ä»¥ä¸‹ä¸º ts ç±»å‹

```ts
interface EventGenerator {
  events: { [eventName: string]: Function[] };

  // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
  on(eventName: string, callback: Function): () => void;

  // åªç›‘å¬ä¸€æ¬¡
  once(eventName: string, callback: Function): () => void;

  // è§¦å‘å…¨éƒ¨
  emitAll(data: any): void;

  // è§¦å‘äº‹ä»¶
  emit(eventName: string, data: any): void;

  // åˆ é™¤äº‹ä»¶ç›‘å¬å™¨
  unbind(eventName: string, callback: Function): void;
}

const eventGenerator: EventGenerator = {
  events: {},

  // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
  on(eventName: string, callback: Function): () => void {
    this.events[eventName] = this.events[eventName] || [];
    this.events[eventName].push(callback);

    return () => {
      this.unbind(eventName, callback);
    };
  },

  // åªç›‘å¬ä¸€æ¬¡
  once(eventName: string, callback: Function): () => void {
    const unbind = this.on(eventName, (data) => {
      unbind();
      callback(data);
    });
    // å¯ç”¨äºåœ¨å‡½æ•°æœªæ‰§è¡Œå‰ï¼Œè§£é™¤ç»‘å®š
    return unbind();
  },

  // è§¦å‘å…¨éƒ¨
  emitAll(data: any): void {
    Object.keys(this.events).forEach((eventName) => {
      if (this.events[eventName]) {
        this.events[eventName].forEach((callback) => {
          callback(data);
        });
      }
    });
  },

  // è§¦å‘äº‹ä»¶
  emit(eventName: string, data: any): void {
    if (eventName === "*") {
      this.emitAll(data);
    } else if (this.events[eventName]) {
      this.events[eventName].forEach((callback) => callback(data));
    }
  },

  // åˆ é™¤äº‹ä»¶ç›‘å¬å™¨
  unbind(eventName: string, callback: Function): void {
    if (!this.events[eventName]) {
      return;
    }

    this.events[eventName] = this.events[eventName].filter(
      (c) => c !== callback
    );
  },
};
```

## å‚è€ƒ

- mitt: https://github.com/developit/mitt/tree/main
- nanoevents: https://github.com/ai/nanoevents
- eventemitter3: https://github.com/primus/eventemitter3
