---
title: Next Auth å¦‚ä½•å®ç°ä¸æ»‘çš„é‚®ä»¶ OTP è®¤è¯
description: å¦‚ä½•åŸºäº Next Auth å®ç°é‚®ä»¶ OTP è®¤è¯ï¼Ÿ
tags: Next,NextAuth,OTP
badges: å®è·µ
publicAt: "2024-03-06"
---

## OTP æ˜¯ä»€ä¹ˆ

OTP è®¤è¯æ˜¯ä¸€ç§åŸºäºä¸€æ¬¡æ€§å¯†ç ï¼ˆOne-Time Passwordï¼‰çš„èº«ä»½éªŒè¯æ–¹æ³•ã€‚é€šå¸¸ï¼Œåœ¨ä¼ ç»Ÿçš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•æ–¹å¼ä¸­ï¼Œç”¨æˆ·åªéœ€æä¾›ç”¨æˆ·åå’Œå¯†ç å³å¯è¿›è¡Œèº«ä»½éªŒè¯ã€‚ç„¶è€Œï¼Œç”±äºå¯†ç å¯èƒ½ä¼šè¢«æ³„éœ²æˆ–çŒœæµ‹ï¼Œè¿™ç§æ–¹å¼å­˜åœ¨ä¸€å®šçš„å®‰å…¨é£é™©ã€‚

ä¸ºäº†å¢å¼ºèº«ä»½éªŒè¯çš„å®‰å…¨æ€§ï¼ŒOTP è®¤è¯å¼•å…¥äº†ä¸€æ¬¡æ€§å¯†ç çš„æ¦‚å¿µã€‚åœ¨ OTP è®¤è¯ä¸­ï¼Œç”¨æˆ·é™¤äº†æä¾›ç”¨æˆ·åå’Œå¯†ç å¤–ï¼Œè¿˜éœ€è¦æä¾›ç”±ç‰¹å®šç®—æ³•ç”Ÿæˆçš„ä¸€æ¬¡æ€§å¯†ç ã€‚è¿™ä¸ªä¸€æ¬¡æ€§å¯†ç é€šå¸¸æ˜¯åŸºäºæ—¶é—´çš„ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†ç ã€‚

![20240306183855](/static/images/next-auth-email-otp/20240306183855.jpg)

ğŸ¤” è¿™ä¸å°±æ˜¯ Magic Link å—ï¼Ÿ
æ˜¯çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„å‘é€ä»‹è´¨æ˜¯é‚®ä»¶çš„è¯ï¼Œé‚£å®ƒä»¬æ˜¯æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«çš„ï¼Œä¸åŒçš„æ˜¯éªŒè¯çš„æ–¹å¼

![20240306184443](/static/images/next-auth-email-otp/20240306184443.jpg)

- OTPï¼šç”¨æˆ·æ”¶åˆ°é‚®ä»¶ï¼ŒæŸ¥çœ‹ â€œéªŒè¯ç â€ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸²æ•°å­—ï¼‰ï¼Œè¿”å›ç½‘é¡µï¼Œè¾“å…¥éªŒè¯ç ï¼Œè®¤è¯å®Œæˆã€‚
- Magic Linkï¼šç”¨æˆ·æ”¶åˆ°é‚®ä»¶ï¼Œç‚¹å‡»é‚®ä»¶å†…éªŒè¯è¿æ¥ï¼ˆä¸€ä¸ªç½‘å€ï¼‰ï¼Œæ‰“å¼€æ–°çš„ç½‘é¡µï¼Œè®¤è¯å®Œæˆã€‚

å¯ä»¥çœ‹åˆ°è¿™é‡Œä¸¤ä¸ªäº¤äº’åŒºåˆ«

1. å¤åˆ¶æˆ–è®°å¿†ä¸€ä¸²æ•°å­— æˆ– ç‚¹å‡»ä¸€ä¸ªç½‘å€
2. åœ¨ç½‘é¡µè¾“å…¥æ•°å­— æˆ– åœ¨æ–°çš„ç½‘é¡µç»§ç»­æ“ä½œï¼ˆåŸç½‘é¡µä¾ç„¶åœ¨ï¼‰

å¦‚ä½•å…±ç”¨ï¼šä½¿ç”¨ OTP çš„æ•°å­—ä½œä¸º Magic Link çš„ tokenï¼Œé‚®ä»¶æ˜¾ç¤º Tokenï¼Œä¹Ÿæ˜¾ç¤ºå¯ä»¥ç‚¹å‡»çš„ Magic Linkã€‚

<div className="max-w-xl mx-auto">
  ![20240306184254](/static/images/next-auth-email-otp/20240306184254.jpg)
</div>

## æ€è·¯

æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ Next Auth çš„é‚®ä»¶è®¤è¯åšæ”¹é€ ï¼Œå®ƒæ˜¯ä½¿ç”¨ Magic Link çš„æ–¹å¼è®¤è¯ï¼Œæˆ‘ä»¬æ”¹é€ çš„æ€è·¯æ˜¯

- token ä½¿ç”¨ 6 ä½éšæœºæ•´æ•°ç”Ÿæˆ
- ç™»å½•/æ³¨å†Œ é‚®ä»¶å‘é€æˆåŠŸåï¼Œæ˜¾ç¤º OTP è¾“å…¥
- æ ¡éªŒ OTP æ˜¯å¦æœ‰æ•ˆï¼Œè®¤è¯å®Œæˆ

## å®ç°

ä¸ºäº†æ›´æ–¹ä¾¿æ­å»ºåŸºç¡€ï¼Œæˆ‘ä»¬ä½¿ç”¨ [t3 - full-stack typesafeÂ Next.js](https://create.t3.gg/) æ¥å¿«é€Ÿåˆ›å»º [App Router](https://nextjs.org/docs)ï¼Œ[Next Auth](https://next-auth.js.org/)ï¼Œ[Prisma](https://www.prisma.io/) çš„é¡¹ç›®

æˆ‘ä»¬æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œ

```shell
pnpm create t3-app@latest
```

![20240306190147](/static/images/next-auth-email-otp/20240306190147.jpg)

![20240306190245](/static/images/next-auth-email-otp/20240306190245.jpg)

![20240306190356](/static/images/next-auth-email-otp/20240306190356.jpg)

æ³¨æ„ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ SQLite ä½œä¸ºæ•°æ®åº“ï¼Œä¸ºäº†å¿«é€Ÿæ¼”ç¤ºã€‚

å®‰è£…å®Œæ¯•åï¼Œä½¿ç”¨ç¼–è¾‘å™¨æ‰“å¼€é¡¹ç›®ï¼ŒT3 é»˜è®¤è®¾ç½®äº† Discord ç¬¬ä¸‰æ–¹éªŒè¯ï¼Œæˆ‘ä»¬å…³é—­å®ƒï¼Œä¸ç„¶ env çš„æ ¡éªŒä¼šæŠ¥é”™ï¼Œæ— æ³•å¯åŠ¨æœåŠ¡ã€‚

- `.env`: åˆ é™¤ `DISCORD_CLIENT_ID` å’Œ `DISCORD_CLIENT_SECRET`
- `src/env.js`: åˆ é™¤ server å’Œ runtimeEnv é‡Œçš„ `DISCORD_CLIENT_ID` å’Œ `DISCORD_CLIENT_SECRET`
- `src/server/auth.ts`: åˆ é™¤ `DiscordProvider` çš„è®¾ç½®

æˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹ Prisma Schema çš„ä»»ä½•ä¸œè¥¿ï¼Œåªéœ€è¦åº”ç”¨ Schema åˆ°æ•°æ®åº“

```shell
npx prisma db push
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¾ç½® [Email Provider](https://next-auth.js.org/providers/email) è¿™é‡Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰é‚®ä»¶å‘é€ï¼Œé‚®ä»¶å‘é€çš„æœåŠ¡æˆ‘ä»¬ä½¿ç”¨ [Resend](https://resend.com/docs/send-with-nextjs)

### ç”³è¯·æœåŠ¡ key

æ³¨å†Œè´¦æˆ·ï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨ Github å¿«é€Ÿç™»å½•

![20240306191708](/static/images/next-auth-email-otp/20240306191708.jpg)

è¾“å…¥ç”¨æˆ·åç§°ï¼Œä¼šè·³è½¬åˆ°æ¬¢è¿ ğŸ‘ é¡µé¢

![20240306191821](/static/images/next-auth-email-otp/20240306191821.jpg)

ç‚¹å‡» â€œAdd API Keyâ€ æŒ‰é’®ï¼Œç”³è¯·å¯†é’¥

![20240306191914](/static/images/next-auth-email-otp/20240306191914.jpg)

å…ˆä¸è¦å…³ç½‘é¡µï¼Œç­‰ä¸€ä¼šä¼šç”¨åˆ°è¿™ä¸ªå¯†é’¥ï¼ŒResend æ¯æ¬¡ç”³è¯·çš„å¯†é’¥åªä¼šçœ‹åˆ°ä¸€æ¬¡ï¼Œä¸ç„¶åªèƒ½ç”³è¯·æ–°çš„å¯†é’¥ï¼ˆä¸é™æ•°é‡ï¼‰

å®‰è£…ä¾èµ–

```shell
pnpm install resend
```

æ‰“å¼€ `src/server/auth.ts` æ–‡ä»¶

```ts
...

import EmailProvider from "next-auth/providers/email";
import crypto from "node:crypto";
import { Resend } from "resend";

...

// Resend æœåŠ¡çš„ Api Key
const resend = new Resend("re_jkp1CHXF_9VwdjEjziwkf9fkLNRcPpXC6");

export const authOptions: NextAuthOptions = {
  ...
  providers: [
    EmailProvider({
      from: "onboarding@resend.dev",
      // è‡ªå®šä¹‰éªŒè¯ç ç”Ÿæˆ
      generateVerificationToken: () => {
        // ç”Ÿæˆ 6 æœªéšæœºæ•´æ•°ä½œä¸ºéªŒè¯ç  (OTP)
        return crypto.randomInt(100000, 999999).toString();
      },
      // å‘é€éªŒè¯è¯·æ±‚
      sendVerificationRequest: async ({ identifier, url, token }) => {
        const user = await db.user.findUnique({
          where: {
            email: identifier,
          },
          select: {
            emailVerified: true,
          },
        });

        const sendTitle = user ? "Sign in" : "Sign up";

        await resend.emails.send({
          from: "onboarding@resend.dev",
          to: identifier,
          subject: `Next Auth OTP - ${sendTitle}`,
          html: `<p>This is your ${sendTitle} code: <strong>${token}</strong> magic link: <a href="${url}">${url}</a></p>`,
        });
      },
    }),
  ],
};

...
```

- å°†æˆ‘ä»¬åˆšåˆšç”³è¯·çš„ `Api Key` å¡«å…¥ `new Resend(Api Key)`
- è®¾ç½® `EmailProvider`ï¼Œè¿™é‡Œ `from` æˆ‘ä»¬ä½¿ç”¨ Resend çš„æµ‹è¯•é‚®ç®±ä½œä¸ºå‘é€æ–¹ï¼Œå®é™…ç”Ÿäº§è¿™é‡Œæ˜¯è‡ªå®šä¹‰åŸŸåï¼ˆResend å…è´¹ç‰ˆæœ¬æ”¯æŒä¸€ä¸ªè‡ªå®šä¹‰åŸŸåï¼Œæ¯æœˆ 3000 å‘é€é¢åº¦ï¼‰
- [`generateVerificationToken`](https://next-auth.js.org/providers/email#customizing-the-verification-token)ï¼šè‡ªå®šä¹‰éªŒè¯ç ç”Ÿæˆ
- [`sendVerificationRequest`](sendVerificationRequest): è‡ªå®šä¹‰é‚®ä»¶å‘é€
- `resend.emails.send`: é‚®ä»¶å‘é€ï¼Œè¿™é‡Œå³å‘é€äº† `token`ï¼Œä¹Ÿå‘é€äº† `url`

æ¥ä¸‹æ¥æˆ‘ä»¬å¯åŠ¨æœåŠ¡ï¼Œåˆ°ç™»å½•é¡µé¢ï¼Œæµ‹è¯•é‚®ä»¶çš„å‘é€ã€‚

```shell
npm run dev
```

æ‰“å¼€ [http://localhost:3000/api/auth/signin](http://localhost:3000/api/auth/signin)

![20240306195548](/static/images/next-auth-email-otp/20240306195548.jpg)

è¾“å…¥ä½ çš„é‚®ç®±ï¼Œç‚¹å‡»å‘é€é‚®ä»¶ã€‚

![20240306195959](/static/images/next-auth-email-otp/20240306195959.jpg)

é‚®ä»¶å‘é€æˆåŠŸï¼Œ

![20240306210549](/static/images/next-auth-email-otp/20240306210549.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†é‚®ä»¶ï¼Œç‚¹å‡» Magic Link é“¾æ¥ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œé¡µé¢ä¼šè·³è½¬åˆ° `/loign` æˆ‘ä»¬ä¸ç”¨ç®¡ï¼Œåœ¨é¡µé¢æ‰“å¼€ [http://localhost:3000/api/auth/session](http://localhost:3000/api/auth/session)

```json
{
  "user": {
    "name": null,
    "email": "123123123@qq.com",
    "image": null,
    "id": "cltftbif60000ickr42mf2954"
  },
  "expires": "2024-04-05T13:06:12.367Z"
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå·²ç»æˆåŠŸç™»å½•ï¼ŒSession ä¿¡æ¯å·²å­˜åœ¨ã€‚ä¸ºäº†æ–¹ä¾¿ä¹‹åçš„æµ‹è¯•ï¼Œå…ˆé€€å‡ºç™»å½• [http://localhost:3000/api/auth/signout](http://localhost:3000/api/auth/signout) ç‚¹å‡» `Sign out` æŒ‰é’®

![20240306211050](/static/images/next-auth-email-otp/20240306211050.jpg)

### OTP è¾“å…¥

æˆ‘ä»¬æ¥è‡ªå®šä¹‰ä¸€ä¸‹ `/login` é¡µé¢ï¼Œåœ¨é‚®ä»¶å‘é€å®Œæˆåï¼Œæ˜¾ç¤º otp è¾“å…¥

åˆ›å»ºæ–‡ä»¶ `src/app/login/page.tsx`

```tsx
"use client";

import { useState } from "react";
import { signIn } from "next-auth/react";

export default function LoginPage() {
  const [email, setEmail] = useState("");

  const handleLogin = async () => {
    const login = await signIn("email", {
      email,
      redirect: false,
    });
    if (login?.error) {
      return alert(login.error);
    }
    alert("Check your email");
  };

  return (
    <div className="p-4">
      <div className="space-x-2">
        <input
          className="h-10 rounded-lg border border-slate-600 p-2"
          type="email"
          placeholder="Email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />
        <button
          onClick={handleLogin}
          className="h-10 rounded-lg bg-slate-800 px-4 py-2 text-white"
        >
          Send Email
        </button>
      </div>
    </div>
  );
}
```

![20240306211921](/static/images/next-auth-email-otp/20240306211921.jpg)

ç•Œé¢æ¯”è¾ƒç®€å•ï¼Œæ¥ç€æˆ‘ä»¬å®ç°ï¼Œé‚®ä»¶å‘é€æˆåŠŸåï¼Œæ˜¾ç¤º OTP è¾“å…¥ï¼Œè¾“å…¥å®ŒæˆååšéªŒè¯ã€‚

**è¿™é‡Œå¦‚ä½•åšéªŒè¯ï¼Ÿ**

æˆ‘ä»¬éœ€è¦ä½¿ç”¨ Magic Link çš„æ€è·¯æ¥å¤„ç†ï¼ŒMagic Link å®é™…æ˜¯ä¸€ä¸ª get æ¥å£ [`http://localhost:3000/api/auth/callback/email`](http://localhost:3000/api/auth/callback/email)ï¼Œä¸»è¦çš„æŸ¥è¯¢å‚æ•°æ˜¯ `email` å’Œ `token`, è€Œæˆ‘ä»¬å°±æ˜¯è¦æ‹¼æ¥ä¸€ä¸ª â€œMagic Linkâ€ æ¥å‘é€è¯·æ±‚ï¼Œè€Œæ ¹æ®è¯·æ±‚è¿”å›çš„çŠ¶æ€å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æœ‰æ•ˆã€‚

æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çŠ¶æ€å€¼çš„åŸå› æ˜¯è¯¥æ¥å£å†…éƒ¨å®ç°çš„æ˜¯é‡å®šå‘ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ html å†…å®¹,æ— æ³•ä½œä¸ºåˆ¤æ–­ã€‚

```tsx
"use client";

import { useState } from "react";
import { signIn } from "next-auth/react";
import { useRouter } from "next/navigation";

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [showOTP, setShowOTP] = useState(false);
  const [otp, setOTP] = useState("");
  const router = useRouter();

  const handleLogin = async () => {
    const login = await signIn("email", {
      email,
      redirect: false,
    });
    if (login?.error) {
      return alert(login.error);
    }
    alert("Check your email");
    setShowOTP(true);
  };

  const handleVerifyOTP = async () => {
    const url = new URL("/api/auth/callback/email", window.location.href);
    url.searchParams.append("token", otp);
    url.searchParams.append("email", email);
    const res = await fetch(url);
    // ä¸æˆåŠŸ
    if (res.status !== 200) {
      return alert("Invalid OTP");
    }
    alert("Login Successful");
    setShowOTP(false);
    // è·³è½¬
    router.replace("/api/auth/session");
  };

  return (
    <div className="space-y-4 p-4">
      <div className="space-x-2">
        <input
          className="h-10 rounded-lg border border-slate-600 p-2"
          type="email"
          placeholder="Email"
          value={email}
          onChange={(e) => setEmail(e.target.value)}
        />
        <button
          onClick={handleLogin}
          className="h-10 rounded-lg bg-slate-800 px-4 py-2 text-white"
        >
          Send Email
        </button>
      </div>
      {showOTP && (
        <div className="space-x-2">
          <input
            className="h-10 rounded-lg border border-slate-600 p-2"
            type="otp"
            placeholder="OTP"
            value={otp}
            onChange={(e) => setOTP(e.target.value)}
          />
          <button
            onClick={handleVerifyOTP}
            className="h-10 rounded-lg bg-slate-800 px-4 py-2 text-white"
          >
            Verify OTP
          </button>
        </div>
      )}
    </div>
  );
}
```

å‘é€é‚®ä»¶

![20240306213132](/static/images/next-auth-email-otp/20240306213132.jpg)

æ”¶åˆ°é‚®ä»¶åï¼Œcopy éªŒè¯ç ã€‚

![20240306213225](/static/images/next-auth-email-otp/20240306213225.jpg)

æˆåŠŸåï¼Œå°†è·³è½¬è‡³ [http://localhost:3000/api/auth/session](http://localhost:3000/api/auth/session)

ä»£ç ä»“åº“ï¼š [next-auth-otp](https://github.com/hehehai/next-auth-otp)

## UI

è¿™é‡Œæ¨èä½¿ç”¨ [React Input OTP](https://github.com/guilhermerodz/input-otp) UI ç»„ä»¶ï¼Œæ•ˆæœå¾ˆæ£’ï¼

![20240306213612](/static/images/next-auth-email-otp/20240306213612.jpg)

```tsx
"use client";
import { OTPInput, SlotProps } from "input-otp";

<OTPInput
  maxLength={6}
  containerClassName="group flex items-center has-[:disabled]:opacity-30"
  render={({ slots }) => (
    <>
      <div className="flex">
        {slots.slice(0, 3).map((slot, idx) => (
          <Slot key={idx} {...slot} />
        ))}
      </div>

      <FakeDash />

      <div className="flex">
        {slots.slice(3).map((slot, idx) => (
          <Slot key={idx} {...slot} />
        ))}
      </div>
    </>
  )}
/>;

// Feel free to copy. Uses @shadcn/ui tailwind colors.
function Slot(props: SlotProps) {
  return (
    <div
      className={cn(
        "relative w-10 h-14 text-[2rem]",
        "flex items-center justify-center",
        "transition-all duration-300",
        "border-border border-y border-r first:border-l first:rounded-l-md last:rounded-r-md",
        "group-hover:border-accent-foreground/20 group-focus-within:border-accent-foreground/20",
        "outline outline-0 outline-accent-foreground/20",
        { "outline-4 outline-accent-foreground": props.isActive }
      )}
    >
      {props.char !== null && <div>{props.char}</div>}
      {props.hasFakeCaret && <FakeCaret />}
    </div>
  );
}

// You can emulate a fake textbox caret!
function FakeCaret() {
  return (
    <div className="absolute pointer-events-none inset-0 flex items-center justify-center animate-caret-blink">
      <div className="w-px h-8 bg-white" />
    </div>
  );
}

// Inspired by Stripe's MFA input.
function FakeDash() {
  return (
    <div className="flex w-10 justify-center items-center">
      <div className="w-3 h-1 rounded-full bg-border" />
    </div>
  );
}

// tailwind.config.ts for the blinking caret animation.
const config = {
  theme: {
    extend: {
      keyframes: {
        "caret-blink": {
          "0%,70%,100%": { opacity: "1" },
          "20%,50%": { opacity: "0" },
        },
      },
      animation: {
        "caret-blink": "caret-blink 1.2s ease-out infinite",
      },
    },
  },
};

// Small utility to merge class names.
import { clsx } from "clsx";
import { twMerge } from "tailwind-merge";

import type { ClassValue } from "clsx";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

## å‚è€ƒ

- [Next Auth](https://next-auth.js.org/)
- [Resend](https://resend.com/)
- [React Input OTP](https://github.com/guilhermerodz/input-otp)
