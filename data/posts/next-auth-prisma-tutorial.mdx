---
title: Next + NextAuth + Prisma ç®€å•åšå®¢
description: Next + NextAuth + Prisma ç®€å•åšå®¢
badges: å®è·µ
tags: Next,NextAuth,Prisma
publicAt: "2022-11-13"
---

### åŸºç¡€ Next

```shell
mkdir my-blog
cd my-blog
npm init -y

# Wrote to my-blog/package.json:
```

åˆå§‹åŒ– `package.json`

```json
{
  "name": "my-blog",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
```

å®‰è£… nextï¼Œè¿™é‡Œä½¿ç”¨ `pnpm` å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„åŒ…ç®¡ç†å·¥å…·ï¼Œå®‰è£…ç‰ˆæœ¬ä¸º `12+` ç›®å‰ next å·²æœ‰ `13 alpha` ç‰ˆæœ¬ï¼Œä½†ä¸ºäº†ç›¸å…³åº“çš„å…¼å®¹æ€§ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ `12`

```shell
pnpm add next@12.3.3 react react-dom
```

```json
{
  "dependencies": {
    "next": "12.3.3",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  }
}
```

æ–‡ä»¶ç»“æ„

```txt
.
â”œâ”€â”€ components
â”œâ”€â”€ pages
â”œâ”€â”€ package.json
â””â”€â”€ pnpm-lock.yaml
```

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112161049.png)

### åŸºç¡€ Typescript

```shell
pnpm add -D ts-node typescript @types/node @types/react
```

```json
{
  "devDependencies": {
    "@types/node": "^18.11.9",
    "@types/react": "^18.0.25",
    "ts-node": "^10.9.1",
    "typescript": "^4.8.4"
  }
}
```

åˆ›å»º `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ES2019",
    "lib": ["DOM", "DOM.Iterable", "ESNext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true
  },
  "exclude": ["node_modules"],
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx"]
}
```

`next typescript` ç±»å‹å…¨å±€æ”¯æŒ `next-env.d.ts`

```ts
/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/basic-features/typescript for more information.
```

å†è®¾ç½®ä¸‹æ‰§è¡Œè„šæœ¬ï¼Œæ­¤æ—¶çš„ `package.json`

```json
{
  "name": "my-blog",
  "version": "1.0.0",
  "description": "",
  "scripts": {
    "dev": "next",
    "build": "next build",
    "start": "next start"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "next": "12.3.3",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@types/node": "^18.11.9",
    "@types/react": "^18.0.25",
    "ts-node": "^10.9.1",
    "typescript": "^4.8.4"
  }
}
```

### åˆ›å»ºé¦–é¡µ

`pages/index.tsx`

```tsx
export default function () {
  return <div>hello</div>;
}
```

è¿è¡Œ

```shell
npm run dev

> my-blog@1.0.0 dev my-blog
> next

ready - started server on 0.0.0.0:3000, url: http://localhost:3000
```

æ‰“å¼€ `http://localhost:3000`

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112162300.png)

### åŸºç¡€ Tailwindcss

ä¸ºäº†å†™äº›åŸºç¡€æ ·å¼æ›´æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨ [tailwind next.js](https://tailwindcss.com/docs/guides/nextjs)

```shell
pnpm add -D tailwindcss postcss autoprefixer
npx tailwindcss init -p
```

`package.json`

```json
"devDependencies": {
	...
	"autoprefixer": "^10.4.13",
	"postcss": "^8.4.19",
	"tailwindcss": "^3.2.4",
	...
}
```

æ–‡ä»¶æ ‘

```txt
.
â”œâ”€â”€ components
â”œâ”€â”€ pages
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ tsconfig.json
```

é…ç½® `tailwind.config.js`

```js
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx}",
    "./pages/**/*.{js,ts,jsx,tsx}",
    "./components/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
```

å¼•å…¥åŸºç¡€æ ·å¼ `styles/globals.css`

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

/* ç½‘é¡µèƒŒæ™¯è‰² */
body {
  @apply bg-gray-200;
}
```

æ ·å¼æˆ‘ä»¬éœ€è¦å…¨å±€å¼•å…¥ `pages/_app.tsx`

```tsx
import { AppProps } from "next/app";

import "styles/globals.css";

const App = ({ Component, pageProps }: AppProps) => {
  return <Component {...pageProps} />;
};

export default App;
```

ä¿®æ”¹ `pages/index.tsx` è¯•è¯•ï¼Œtailwind æ˜¯å¦ç”Ÿæ•ˆ

```tsx
export default function () {
  return <div className="text-red-500 p-4">hello</div>;
}
```

```shell
npm run dev
```

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112164013.png)

ok, è¿™é‡Œæˆ‘ä»¬çš„åŸºç¡€å°±æ­å»ºå¥½äº†ï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥ç›´æ¥å®‰è£… NextAuth

### ä½¿ç”¨ NextAuth

```shell
pnpm add next-auth
```

å½“å‰ `package.json`

```json
"dependencies": {
	...
	"next-auth": "^4.16.4",
	...
},
```

åˆ›å»º next auth æ¥å£ä»£ç† `pages/api/auth/[...nextauth].ts`

```ts
import { NextApiHandler } from "next";
import { NextAuthOptions } from "next-auth";
import GitHubProvider from "next-auth/providers/github";
import NextAuth from "next-auth/next";

const authOptions: NextAuthOptions = {
  providers: [
    GitHubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
  ],
};

// éœ€è¦ä¸€ä¸ªå¯¼å‡ºçš„ handlerï¼Œä½¿ç”¨ next auth åšä»£ç†
const authHandler: NextApiHandler = (req, res) =>
  NextAuth(req, res, authOptions);

export default authHandler;
```

- `[...nextauth].ts`: ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Ÿè¿™æ˜¯ Next api path åŒ¹é…ï¼Œè¿™å°†ä¼šåŒ¹é… `/api/auth/**/*` æ‰€ä»¥è·¯å¾„çš„è¯·æ±‚
- `GitHubProvider`: ä½¿ç”¨ Github çš„ OAuth
- `process.env`: è·å–ç¯å¢ƒå˜é‡ï¼Œä»–å¯ä»¥æ¥è‡ªä½ çš„ `.env` è„šæœ¬å‚æ•°ï¼Œç³»ç»Ÿç¯å¢ƒç­‰ç¯å¢ƒå˜é‡

æ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å»ç”³è¯·ä¸€ä¸ª Github OAuth çš„ tokenï¼Œç”¨äºè¯·æ±‚

### ç”³è¯· Github OAuth App Token

1. [Github OAuth Apps](https://github.com/settings/developers)

æˆ‘è¿™é‡Œå·²ç»æœ‰ App, ä½ çš„å¯èƒ½æ˜¯ç©ºçš„ï¼Œä½†ä¸è¦ç´§ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ app

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112170734.png)

2. ç‚¹å‡» "New OAuth App"ï¼Œå®Œæˆèº«ä»½è®¤è¯
3. å¡«å†™å†…å®¹

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112171103.png)

- `Application name`: åº”ç”¨åç§°ï¼Œéšä¾¿å¡«
- `Homepage URL`: åº”ç”¨é¦–é¡µï¼Œéšä¾¿å¡«
- `Application description`: åº”ç”¨è¯´æ˜ï¼Œéšä¾¿å¡«
- `Authorization callback URL`: è®¤è¯å›æ‰§åœ°å€ï¼Œ`/api/auth/callback/github` è·¯å¾„éœ€è¦å¡«å†™ next auth çš„ä»£ç†ï¼Œè¿™ç”¨äº next auth æ¥æ¥æ”¶ OAuth è®¤è¯çš„ç»“æœã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ `/api/auth` next auth ä¼šè¯†åˆ«å›æ‰§çš„, å®Œæ•´: `http://localhost:3000/api/auth/callback/github`

4. ç‚¹å‡» "Register application"

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112171707.png)

æˆ‘ä»¬å·²ç»çœ‹åˆ°æœ‰ `Client ID` äº†ï¼Œä½† `Client secrets` è¿˜æ²¡æœ‰ï¼Œæˆ‘ä»¬æ¥ç”Ÿæˆä¸€ä¸ª

5. ç‚¹å‡» "Generate a new client secret"

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112171915.png)

nice!, æˆ‘ä»¬å·²ç»æœ‰è‡ªå·±çš„ Github OAuth tokenï¼Œä¸‹é¢å¼€å§‹é…ç½®å§ï¼

### é…ç½® ENV

åˆ›å»º `.env`

```txt
# Github OAuth
GITHUB_ID=Client_ID
GITHUB_SECRET=Client_secrets
```

â—ï¸ å¼ºçƒˆå»ºè®®ï¼Œå°†è¯¥æ–‡ä»¶æ·»åŠ åˆ° `.gitignore` ä¸­ï¼Œé¿å…æ•æ„Ÿä¿¡æ¯æ³„æ¼ï¼Œåœ¨éƒ¨ç½²æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿è¡Œæ—¶çš„å®¿ä¸»ç¯å¢ƒçš„ç¯å¢ƒå˜é‡æ›¿ä»£è¯¥æ–‡ä»¶

```txt
node_modules/
.next/
.DS_STORE
.env
```

æ–‡ä»¶æ ‘

```txt
.
â”œâ”€â”€ components
â”œâ”€â”€ pages
â”‚   â”œâ”€â”€ _app.tsx
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ auth
â”‚   â”‚       â””â”€â”€ [...nextauth].ts
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ styles
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ tsconfig.json
```

### ä½¿ç”¨ NextAuth Github ç™»å½•

NextAuth æ˜¯æ”¯æŒä¸é€‚åº”æ•°æ®åº“åšèº«ä»½è®¤è¯ç™»å½•çš„ï¼Œå®é™…ä½¿ç”¨ OAuth å¯ä»¥æ¯æ¬¡ç™»å½•çš„æ—¶å€™è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€æ•°æ®åº“å­˜å‚¨äº†ã€‚æˆ‘ä»¬å…ˆæ¥éªŒè¯ä¸‹ã€‚

1. è¿è¡Œ

```shell
npm run dev
```

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112172909.png)

2. å½“å‰ `Session` ä¿¡æ¯ï¼Œè®¿é—® `http://localhost:3000/api/auth/session`

è¯¥æ¥å£æ˜¯ NextAuth ä»£ç†ï¼Œä¼šè¿”å›å½“å‰ç™»å½•çš„ `Session` ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä¸ºç©ºï¼Œé‚£å°±ä»£è¡¨æ²¡æœ‰ç™»å½•ã€‚

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112173056.png)

3. ç™»å½•ï¼Œè®¿é—®: `http://localhost:3000/api/auth/signin` è¯¥æ¥å£æ˜¯ NextAuth ä»£ç†ï¼Œè¿”å›ä¸€ä¸ªç™»å½•é¡µé¢ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬é…ç½®çš„ Github OAuth ç™»å½•æ˜¯æœ‰çš„

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112173246.png)

4. ç‚¹å‡»ç™»å½• "Sign in with GitHub"

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112173433.png)

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112173445.png)

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112173453.png)

è¿™é‡Œç™»å½•åè·³è½¬åˆ°æˆ‘ä»¬çš„é¦–é¡µäº†ï¼Œè¿™æ˜¯ NextAuth é»˜è®¤çš„ç™»å½•æˆåŠŸè·³è½¬é¡µ `/`

5. æŸ¥çœ‹ç™»å½• `Session` è®¿é—®: `http://localhost:3000/api/auth/session`

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112173630.png)

6. é€€å‡ºç™»å½•ï¼Œè®¿é—®: `http://localhost:3000/api/auth/signout`

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221112174214.png)

7. ç‚¹å‡» "Sign out", æ­¤æ—¶æˆåŠŸé€€å‡ºï¼Œå°†è·³è½¬åˆ°é¦–é¡µ, è¿™ä¹Ÿæ˜¯ NextAuth é»˜è®¤çš„ `/`

æƒ³è¦ç¡®è®¤å·²ç»é€€å‡ºçš„è¯ï¼Œå¯ä»¥è®¿é—®: `http://localhost:3000/api/auth/session`

### åŸºç¡€ UI

ä¸‹é¢æˆ‘ä»¬å°†ç¼–å†™ä¸€ä¸ªç®€å•çš„ UIï¼Œæ–¹ä¾¿æˆ‘ä»¬ä¹‹åçš„æ“ä½œã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿä¼šæ ¹æ®å½“å‰çš„ç™»å½•çŠ¶æ€æ˜¾ç¤ºéšè—ä¸€äº›ç•Œé¢å…ƒç´ ã€‚

å…ˆæ¥ä»‹ç»ä¸€ä¸‹ NextAuth å°è£…çš„å®¢æˆ·ç«¯ç™»å½•ä¿¡æ¯è·å–

#### [useSession()](https://next-auth.js.org/getting-started/client#usesession)

```ts
import { useSession } from "next-auth/react";

export default function Component() {
  const { data: session, status } = useSession();

  if (status === "authenticated") {
    return <p>Signed in as {session.user.email}</p>;
  }

  return <a href="/api/auth/signin">Sign in</a>;
}
```

#### [getSession()](https://next-auth.js.org/getting-started/client#getsession)

```ts
async function myFunction() {
  const session = await getSession();
  /* ... */
}
```

#### Header

`components/Header.tsx`

```tsx
import { useMemo } from "react";
import Link from "next/link";
import { useSession } from "next-auth/react";

const Header = () => {
  const { data: session, status } = useSession();

  const isLoading = useMemo(() => {
    return status === "loading";
  }, [status]);

  return (
    <div className="px-8 py-4 mx-auto">
      <div className="bg-white px-6 py-4 flex items-center justify-between">
        <div className="space-x-6">
          <Link href="/">
            <a className="bold">é¦–é¡µ</a>
          </Link>
        </div>
        {isLoading ? (
          <div>éªŒè¯ä¸­...</div>
        ) : (
          <div className="flex items-center space-x-6">
            {session ? (
              <>
                <p>
                  {session?.user?.name} ({session?.user?.email})
                </p>
                <Link href="/api/auth/signout">
                  <a>é€€å‡º</a>
                </Link>
              </>
            ) : (
              <Link href="/api/auth/signin">
                <a>ç™»å½•</a>
              </Link>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

export default Header;
```

- `useSession()`: è¿™é‡Œæ˜¯ä¸€ä¸ª hookï¼Œå†…éƒ¨æ˜¯æœ‰è·å– Context çš„ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½® NextAuthReact çš„ `SessionProvider` ï¼ˆè§ä¸‹æ–‡ï¼‰
- `status === 'loading'`: `Session` æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼ˆ`loading` éªŒè¯ä¸­, `authenticated` å·²è®¤è¯, `unauthenticated` æœªè®¤è¯ï¼‰
- `session`: `Session` ä¸­çš„ä¿¡æ¯å¯åœ¨ [`api/auth/session`](http://localhost:3000/api/auth/session) æŸ¥çœ‹

```json
{
  "user": {
    "name": "ä¸€å—æœ¨å¤´",
    "email": "riverhohai@gmail.com",
    "image": "https://avatars.githubusercontent.com/u/12692552?v=4"
  },
  "expires": "2022-12-13T01:33:02.088Z"
}
```

`pages/_app.tsx`

```tsx
import { AppProps } from "next/app";
import { SessionProvider } from "next-auth/react";
import { Session } from "next-auth";

import "styles/globals.css";

const App = ({ Component, pageProps }: AppProps<{ session?: Session }>) => {
  return (
    <SessionProvider session={pageProps.session}>
      <Component {...pageProps} />
    </SessionProvider>
  );
};

export default App;
```

`components/Layout.tsx`

```tsx
import React, { ReactNode } from "react";
import Header from "./Header";

const Layout: React.FC<{ children?: ReactNode }> = (props) => (
  <div>
    <Header />
    <div className="px-8">{props.children}</div>
  </div>
);

export default Layout;
```

`components/index.tsx`

```tsx
import Layout from "../components/Layout";

export default function () {
  return (
    <Layout>
      <main className="bg-white">
        <div className="text-red-500 p-4">hello</div>
      </main>
    </Layout>
  );
}
```

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113093518.png)

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113093808.png)

æ–‡ä»¶æ ‘

```txt
.
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ Header.tsx
â”‚   â””â”€â”€ Layout.tsx
â”œâ”€â”€ pages
â”‚   â”œâ”€â”€ _app.tsx
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ auth
â”‚   â”‚       â””â”€â”€ [...nextauth].ts
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ styles
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ tsconfig.json
```

### åŸºç¡€ Prisma

```shell
pnpm add prisma @prisma/client @next-auth/prisma-adapter
```

`package.json`

```json
"dependencies": {
	...
    "@next-auth/prisma-adapter": "^1.0.5",
    "@prisma/client": "^4.6.1",
    "prisma": "^4.6.1",
    ...
},
```

åˆå§‹åŒ– Prisma é¡¹ç›®

```shell
npx prisma init

âœ” Your Prisma schema was created at prisma/schema.prisma
  You can now open it in your favorite editor.

warn You already have a .gitignore file. Don't forget to add `.env` in it to not commit any private information.

Next steps:
1. Set the DATABASE_URL in the .env file to point to your existing database. If your database has no tables yet, read https://pris.ly/d/getting-started
2. Set the provider of the datasource block in schema.prisma to match your database: postgresql, mysql, sqlite, sqlserver, mongodb or cockroachdb.
3. Run prisma db pull to turn your database schema into a Prisma schema.
4. Run prisma generate to generate the Prisma Client. You can then start querying your database.

More information in our documentation:
https://pris.ly/d/getting-started
```

å¯ä»¥çœ‹åˆ°æ–°æ–‡ä»¶ `prisma/schema.prisma`

```txt
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

- `generator client`: æ˜¯ Prisma ç”¨äºå®¢æˆ·ç«¯ç±»å‹ç”Ÿæˆçš„é…ç½®ï¼Œè¿™é‡Œ `provider` ä½¿ç”¨ç›®å‰å®˜æ–¹çš„ `prisma-client-js` ï¼ˆç›®å‰å®˜æ–¹è¿‘è¿™ä¸€ä¸ªç”Ÿæˆå™¨ï¼‰
- `datasource db`: æ•°æ®åº“è¿æ¥å™¨çš„é…ç½®ï¼Œè¿™é‡Œè¿æ¥çš„æ˜¯ `postgresql` åœ°å€è¿™é‡Œä½¿ç”¨ç¯å¢ƒå˜é‡

æˆ‘ä»¬å†çœ‹ `.env` æ–‡ä»¶ï¼Œå¯ä»¥å‘ç° Prisma åˆå§‹åŒ–è‡ªåŠ¨ä¸ºæˆ‘ä»¬æ·»åŠ äº† `DATABASE_URL`ã€‚

```txt
# Github OAuth
GITHUB_ID=Github_Client_ID
GITHUB_SECRET=Github_Client_secret


# This was inserted by `prisma init`:
# Environment variables declared in this file are automatically made available to Prisma.
# See the documentation for more detail: https://pris.ly/d/prisma-schema#accessing-environment-variables-from-the-schema

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server, MongoDB and CockroachDB.
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"
```

- **User**: æ•°æ®åº“åç§°
- **Password**: æ•°æ®åº“å¯†ç 
- **Host**: æ•°æ®åº“ IP åœ°å€
- **Port**: æ•°æ®åº“ ç«¯å£
- **Database name**: æ•°æ®åº“åç§°
- å…¶ä»–çš„ä¸ºè¿æ¥æŸ¥è¯¢å‚æ•°é…ç½®ï¼Œå¯é€‰

1. åˆ›å»ºæ•°æ®åº“
   é¦–å…ˆä½ çš„ç”µè„‘è¦æœ‰å®‰è£… Postgresql æ•°æ®åº“ï¼Œå¹¶ä¸”é…ç½®äº† Bin Pathï¼Œè¿™è¦æ‰å¯ä»¥æ›´æ–¹ä¾¿çš„ä½¿ç”¨ç»ˆç«¯å‘½ä»¤

```shell
createdb my-blog
```

```shell
ğŸ¤™  my-blog git:(main) âœ— psql
psql (14.5 (Homebrew))
Type "help" for help.

guanwei=# \l
                            List of databases
    Name    |  Owner  | Encoding | Collate | Ctype |  Access privileges
------------+---------+----------+---------+-------+---------------------
 my-blog    | guanwei | UTF8     | C       | C     |
 ...
(7 rows)

guanwei=#
```

å¦åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ UI æ¥è¿æ¥åˆ›å»ºæ•°æ®åº“

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113102921.png)

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113102951.png)

æµ‹è¯•æˆ‘ä»¬æ˜¯å¦é…ç½®æ­£å¸¸ï¼Œæˆ‘ä»¬æ‰§è¡Œ `npx prisma db pull`

```shell
ğŸ¤™  my-blog git:(main) âœ— npx prisma db pull
Prisma schema loaded from prisma/schema.prisma
Environment variables loaded from .env
Datasource "db": PostgreSQL database "my-blog", schema "public" at "localhost:5432"

âœ– Introspecting based on datasource defined in prisma/schema.prisma
Error:
P4001 The introspected database was empty:

prisma db pull could not create any models in your schema.prisma file and you will not be able to generate Prisma Client with the prisma generate command.

To fix this, you have two options:

- manually create a table in your database.
- make sure the database connection URL inside the datasource block in schema.prisma points to a database that is not empty (it must contain at least one table).

Then you can run prisma db pull again.
```

- `db pull`: ä»æ•°æ®åº“æ‹‰å–è¡¨ç»“æ„ï¼Œç”Ÿæˆå¯¹åº”çš„ Prisma Schema

æ­¤æ—¶æˆ‘ä»¬çš„æ•°æ®åº“æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥è¿™é‡Œæœ‰ä¸€ä¸ª `P4001` çš„é”™è¯¯ï¼Œä¸è¿‡åˆ«æ‹…å¿ƒï¼Œèµ·ç æˆ‘ä»¬å¯ä»¥è¿æ¥åˆ°æ•°æ®åº“äº†ã€‚

2. ç¼–å†™ Prisma Schema
   `prisma/schema.prisma`

```txt
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime? @updatedAt @map("updated_at")

  accounts Account[]
  sessions Session[]

  @@map("users")
}

model Account {
  id                String   @id @default(cuid())
  type              String
  provider          String
  providerAccountId String   @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  createdAt         DateTime @default(now()) @map(name: "created_at")
  updatedAt         DateTime @updatedAt @map(name: "updated_at")
  userId            String   @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  expires      DateTime
  userId       String   @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}
```

æ­¤æ•°æ®æ¥è‡ª [NextAuthPrismaAdapter](https://next-auth.js.org/adapters/prisma#setup) è¿™é‡Œæœ‰äº›ç®€å•çš„è¡¨å’Œå­—æ®µçš„åç§°è°ƒæ•´ï¼Œä¸è¿‡ä½ è¦æ˜¯ç›´æ¥ä½¿ç”¨ NextAuth çš„ä¹Ÿå¯ä»¥ï¼ŒåŸè°…æˆ‘å¼ºè¿«ç—‡ ğŸ«£ã€‚

æœ‰å…³ Prisma Schema çš„è¯­æ³•ï¼Œå¯ä»¥å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)ï¼Œä¸‹é¢æˆ‘è¿‘ä»‹ç»äº›åŸºæœ¬çš„è¯­æ³•ï¼Œæ–¹ä¾¿ç†è§£

- `model`: ç†è§£ä¸ºæ•°æ®åº“è¡¨ï¼Œè€Œ `model` åçš„åç§°ï¼Œé»˜è®¤æ˜¯æ•°æ®åº“è¡¨åï¼Œä½†ä½†æˆ‘ä»¬åœ¨ Schema åº•éƒ¨è®¾ç½®äº† `@@map('...')` æ—¶ï¼ŒPrisma å°†ä»¥è¯¥åç§°æ˜ å°„åˆ°æ•°æ®åº“è¡¨
- `String Int DateTime` ä»£ç çš„æ•°æ®ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Postgresql æ‰€ä»¥è¿™é‡Œç›´æ¥ä½¿ç”¨ Prisma å¤„ç†çš„é»˜è®¤ç±»å‹å°±è¡Œï¼Œè‹¥æ˜¯ MySQL çš„è¯ï¼Œå¯¹äº `access_token` Prisma çš„ `String` ä¼šé»˜è®¤ä½¿ç”¨ `CARHCAR(191)` çš„é•¿åº¦ï¼Œè¿™é‡Œå¯èƒ½ä¸å¤Ÿï¼Œéœ€è¦ä½¿ç”¨ `String @db.Text` è¿™ç§ï¼Œæ ‡æ˜æ•°æ®åº“å­—æ®µç±»å‹
- `?` è¡¨ç¤ºè¯¥å­—æ®µå€¼å¯ä»¥ä¸ºç©ºï¼Œè¿™å…¶å®å°±æ˜¯ `DEFAULT NULL`ï¼Œç›¸åçš„æ˜¯ `NOT NULL`
- `@id`ï¼šè¡¨ä¸»é”®
- `@unique`ï¼šå”¯ä¸€é”®ï¼Œè¿™é‡Œä¸åœ¨å­—æ®µåä½¿ç”¨çš„ï¼Œè€Œåœ¨ Schema ä¸­ç›´æ¥è®¾ç½®çš„ `@@unique([...])` è¡¨ç¤ºç¬¦åˆå”¯ä¸€é”®
- `@default(...)`: å­—æ®µé»˜è®¤å€¼ï¼Œä½†å­—æ®µæ²¡æœ‰ `?` å¹¶ä¸”æ²¡æœ‰è®¾ç½®é»˜è®¤å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µå°±æ˜¯å¿…å¡«çš„
- `@map(...)`: è¡¨å­—æ®µåç§°
- `@updatedAt` å’Œåˆ›å»ºæ—¶é—´é»˜è®¤æ—¶é—´ä¸ºç°åœ¨çš„ä¸åŒï¼Œè¿™é‡Œæ˜¯ Prisma è¡¨ç¤ºä¿®æ”¹æ—¶é—´ï¼Œå®é™… Prisma ä¼šè¯†åˆ«è¯¥å€¼ä¸ºä¸€ä¸ª hookï¼Œåœ¨æ•°æ®ä¿®æ”¹æ—¶ï¼Œè°ƒç”¨ hook ä¿®æ”¹è¯¥æ—¶é—´ï¼ˆåŸå­æ“ä½œï¼‰ï¼Œè¿™æ ·å°±ä¸éœ€è¦æˆ‘ä»¬å†å¤„ç†äº†
- `cuid(), now()` è¿™äº›æ˜¯ Prisma Schema ä¸­å†…ç½®çš„å‡½æ•°ï¼Œæ‰§è¡Œåä¼šè¿”å›ä¸€ä¸ªæˆ–å¤šä¸ªå€¼ï¼Œæ–¹ä¾¿å…¶ä»–å‡½æ•°è‡ªå·±è°ƒç”¨
- `@relation` è¿™å°±æ˜¯è¡¨å…³è”çš„æ ‡è¯†ï¼Œå¦‚æœä½ æ¸…æ¥š SQL ç±»æ•°æ®åº“çš„è¡¨å…³è”å½¢å¼ï¼Œé‚£ä¹ˆè¿™ä¸ª Schema å®é™…å¾ˆç›´è§‚ï¼Œè¿™å‡ ä¸å¤šä»‹ç»äº†ï¼Œå¯å‚è€ƒ[å®˜ç½‘æ–‡æ¡£](https://www.prisma.io/docs/concepts/components/prisma-schema/relations)

okï¼Œå†æ¥ä»‹ç»ä¸‹ï¼Œè¿™äº›è¡¨åˆ†åˆ«æ˜¯å¹²ä»€ä¹ˆçš„

- `User`: ç”¨æˆ·
- `Account`: è´¦å·
- `Session`: ç™»å½•èº«ä»½æ ‡è¯†
- `VerificationToken`: éªŒè¯ä¿¡æ¯

åœ¨ NextAuth çš„è®¾è®¡ä¸­ï¼Œç”¨æˆ·æ˜¯ä»¥ `email` åšå”¯ä¸€æ ‡è¯†çš„ï¼Œè¿™å°±ä»£è¡¨ï¼Œç”¨æˆ· A å®ƒæœ‰ä¸€ä¸ª Github è´¦å·ï¼Œä½¿ç”¨äº† `a@gmail.com` æ³¨å†Œçš„ï¼Œè¿˜æœ‰ä¸€ä¸ª Apple è´¦å·ä¹Ÿä½¿ç”¨ `a@gmail.com` é‚£ä¹ˆæ­¤åªæœ‰ä¸€ä¸ª ç”¨æˆ· A ï¼Œä½†æœ‰ä¸¤ä¸ªè´¦å· Github, Apple ä»–ä»¬å›  `a@gmail.com` äº§ç”Ÿå…³è”ã€‚

`Session` çš„è¯å…¶å®å’Œæˆ‘ä»¬ä¹‹å‰æŸ¥çœ‹çš„ `/api/auth/session` æœ‰å…³è”ï¼Œè¿™ä¼šé”®ç™»å½•èº«ä»½åœ¨æœåŠ¡ç«¯æŒä¹…åŒ–ï¼Œä¸”è¿™é‡ŒæŠ¥é”™çš„éªŒè¯ token ç¡®ä¿å®¢æˆ·ç«¯çš„ `session` æ•°æ®æœ‰æ•ˆ

`VerificationToken` æ˜¯ç”¨æ¥å­˜å‚¨éªŒè¯ä¿¡æ¯çš„ï¼Œåœºæ™¯ï¼šæœåŠ¡å™¨ç»™ ç”¨æˆ· X çš„ `x@gmail.com` å‘é€äº†ä¸€ä¸ªéªŒè¯é‚®ä»¶ï¼Œç”¨æˆ· X æ”¶åˆ°é‚®ä»¶ï¼Œç‚¹å‡»éªŒè¯è¿æ¥ï¼ˆæˆ–çœ‹åˆ°ä¸€ä¸²éªŒè¯ç ï¼‰ï¼Œè¿”å›æˆ‘ä»¬çš„é¡µé¢ï¼Œè¾“å…¥ä¿¡æ¯ç‚¹å‡»éªŒè¯ï¼Œæ­¤æ—¶æˆ‘ä»¬æœåŠ¡å™¨æ‹¿åˆ°æ•°æ®ä¿¡æ¯ï¼Œéœ€è¦å’Œæ•°æ®åº“æŸ¥è¯¢éªŒè¯ä¿¡æ¯çš„æœ‰æ•ˆæ€§ï¼ˆæ˜¯å¦ä¸ºè¯¥é‚®ä»¶çš„ï¼Œæœ‰æ²¡æœ‰è¿‡æœŸï¼‰ã€‚åŒç†æˆ‘ä»¬å›½å†…å¸¸ç”¨çš„æ‰‹æœºçŸ­ä¿¡éªŒè¯ã€‚

3. æ˜ å°„ Schema åˆ°æ•°æ®åº“

```shell
ğŸ¤™  my-blog git:(main) npx prisma migrate dev --name auth-base

Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "my-blog", schema "public" at "localhost:5432"

Applying migration `20221113032027_auth_base`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20221113032027_auth_base/
    â””â”€ migration.sql

Your database is now in sync with your schema.

âœ” Generated Prisma Client (4.6.1 | library) to ./node_modules/.pnpm/registry.npmmirror.com+@prisma+client@4.6.1_prisma@4.6.1/node_module
s/@prisma/client in 204ms
```

- `migrate dev`: è¿™æ˜¯ Prisma å†…ç½®çš„æ•°æ®ç»“æ„ç®¡ç†å·¥å…·ï¼Œè¿™é‡Œä½¿ç”¨ `dev` å¼€å‘æ¨¡å¼
- `--name auth-base`: è‡ªå®šä¹‰ migrate åç§°

è¿™é‡Œå…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨ `npx prisma db push` æ­¤å‘½ä»¤å°† Schema å¼ºåˆ¶æ˜ å°„åˆ°æ•°æ®åº“ï¼Œè¿™ä¹Ÿæ˜¯å› ä¸ºæ•°æ®åº“æ˜¯ç©ºçš„ï¼Œå¦åˆ™ä¸å»ºè®®ä½¿ç”¨ï¼ˆé™¤éä½ ç¡®å®šä½ åœ¨å¹²ä»€ä¹ˆï¼‰ï¼

æ‰§è¡Œå®Œè¯¥å‘½ä»¤åï¼Œä¼šåœ¨ `prisma/` ä¸‹ç”Ÿæˆ migrate ç®¡ç†æ–‡ä»¶

```txt
prisma/
â”œâ”€â”€ migrations
â”‚   â”œâ”€â”€ 20221113032027_auth_base
â”‚   â”‚   â””â”€â”€ migration.sql
â”‚   â””â”€â”€ migration_lock.toml
â””â”€â”€ schema.prisma
```

æŸ¥çœ‹æ•°æ®åº“

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113112627.png)

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113112801.png)

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113112823.png)

å¯ä»¥æ³¨æ„ä¸‹è¡¨ç»“æ„ï¼Œå…³è”è¡¨æ˜¯ä½¿ç”¨äº†å¤–é”®çš„æ–¹å¼å¤„ç†ã€‚

### ä½¿ç”¨ Prisma

é¦–å…ˆæˆ‘ä»¬è¦åšçš„å°±æ˜¯è¿æ¥ Prismaï¼Œè¿™é‡Œè¦åˆ›å»ºä¸€ä¸ªå…¨å±€çš„è¿æ¥å•ä¾‹
`lib/db/prisma.ts` åœ¨é¡¶å±‚æ–°å»ºä¸€ä¸ª `lib` ç›®å½•

```ts
import { PrismaClient } from "@prisma/client";

declare global {
  var __db__: PrismaClient;
}

let prisma: PrismaClient;

if (process.env.NODE_ENV === "production") {
  prisma = new PrismaClient();
} else {
  if (!global.__db__) {
    global.__db__ = new PrismaClient();
  }
  prisma = global.__db__;
  prisma.$connect();
}

export const db = prisma;
```

- `declare gloabl __db__`: å…¨å±€å˜é‡ç±»å‹
- ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬çš„æœåŠ¡åœ¨éƒ¨ç½²çš„æ—¶å€™ä¼šè¿è¡Œï¼Œä¹Ÿå°±ä»£è¡¨ä»…åœ¨éƒ¨ç½²å¯åŠ¨çš„æ—¶å€™ä¼šè¿æ¥ä¸€æ¬¡
- éç”Ÿäº§ç¯å¢ƒï¼Œçƒ­å¼€å‘çš„æƒ…å†µä¸ºäº†é¿å…å¤šæ¬¡åˆ›å»ºè¿æ¥å®ä¾‹ï¼Œè¿™é‡Œå°†ç¬¬ä¸€æ¬¡åˆ›å»ºçš„å®ä¾‹æŒ‚åœ¨åˆ°å…¨å±€ï¼Œä¸‹ä¸€æ¬¡ç›´æ¥ä½¿ç”¨ä¹™å­˜åœ¨çš„å®ä¾‹å³å¯
- `prisma.$connect()`: åˆå§‹åŒ–çš„æ—¶é—´å…ˆåšä¸€æ¬¡è¿æ¥ï¼Œè¿™æ˜¯ä¸ºäº†è§£å†³åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œé‡å¯æœåŠ¡åç¼“å­˜æ˜¯çƒ­å¼€å‘çš„å¢é‡ï¼Œæ­¤æ—¶æ•°æ®åº“è¯·æ±‚ä¼šå‡ºç°æœªè¿æ¥çš„é”™è¯¯ï¼ˆåˆ·æ–°é¡µé¢-ä¼šå¥½ï¼‰ã€‚

è¿™é‡Œä¸ºäº†æ–¹ä¾¿å¼•ç”¨ï¼Œæˆ‘ä»¬åœ¨ `tsconfig.json` ä¸­è®¾ç½®è·¯å¾„åˆ«å

```json
{
	"compilerOptions": {
		...
		"baseUrl": ".",
		"paths": {
		  "~/lib/*": [
			"lib/*"
		  ],
		  "~/components/*": [
			"components/*"
		  ]
		}
	}
}
```

è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»¥ä¸‹é¢è¿™ç§æ–¹å¼å¼•ç”¨ `lib` å’Œ `components`

```ts
import { db } from "~/lib/db/prisma";
import Layout from "~/components/Layout";
```

ok, å…ˆå°† `pages/index.tsx` ä¸­çš„è·¯å¾„ä¼˜åŒ–ä¸‹

```tsx
// import Layout from "../components/Layout"; æ›¿æ¢
import Layout from "~/components/Layout";

...
```

æ¥ç€æˆ‘ä»¬ä¼˜åŒ–ä¸‹ `.env` æ–‡ä»¶ï¼Œå¹¶ä¸”é…ç½®ä¸¤ä¸ªæ–°çš„é¢ç¯å¢ƒå˜é‡

```txt
# prisma db connect url
DATABASE_URL="postgresql://johndoe:randompassword@localhost:5432/mydb?schema=public"

# Github OAuth - https://github.com/settings/developers
GITHUB_ID=Github_Client_ID
GITHUB_SECRET=Github_Client_secret

# Next Auth url
NEXTAUTH_URL=http://localhost:3000

# Next Auth secret
SECRET=Some_secret
```

- `NEXTAUTH_URL`: åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹æœ‰æ•ˆï¼Œè¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸‹ï¼Œæ”¹å€¼è¢« NextAuth ä½¿ç”¨ä½œä¸ºè·¯å¾„è¡¥å…¨çš„ï¼Œé€šå¸¸è®¾ç½®ä¸ºéƒ¨ç½²åº”ç”¨çš„ç½‘å€ã€‚å¦‚æœä½¿ç”¨ [Vercel](https://vercel.com/) å¯ä»¥ä¸è®¾ç½®ï¼Œéƒ¨ç½²ç¯å¢ƒå˜é‡ä¼šå­˜åœ¨è¯¥å€¼ã€‚æ›´è¯¦ç»†å‚è€ƒ[å®˜ç½‘](https://next-auth.js.org/configuration/options#nextauth_url)
- `SECRET`: ç”¨æˆ·ç­¾å‘ä»¤ç‰Œçš„åŠ å¯†ï¼Œä¹‹å‰è®¾ç½®æ˜¯å› ä¸ºå¼€å‘é™Œç”Ÿä¸‹ NextAuth ä¼šè‡ªå·±ç”Ÿæˆï¼Œè¿™é‡Œæˆ‘ä»¬è‡ªå·±è®¾ç½®ä¸‹ã€‚`Some_secret` ä¸ºä½ çš„å¯†é’¥

å¦‚æœä½ ä½¿ç”¨ç±» `unix` ç³»ç»Ÿï¼Œå¯ä»¥ä½¿ç”¨ `openssl` ç”Ÿæˆä¸€ä¸ª

```shell
openssl rand 32 -base64

# qu0ue5LgDsYC+v4fvRzfBGJxUVwTOttVRSF6QdPo0Dw=
```

ä¸º NextAuth è®¾ç½® Prisma è½¬æ¥å™¨

```ts
import { NextApiHandler } from "next";
import { NextAuthOptions } from "next-auth";
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import GitHubProvider from "next-auth/providers/github";
import NextAuth from "next-auth/next";
import { db } from "~/lib/db/prisma";

const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(db),
  secret: process.env.SECRET,
  providers: [
    GitHubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
  ],
};

const authHandler: NextApiHandler = (req, res) =>
  NextAuth(req, res, authOptions);

export default authHandler;
```

- `adapter: PrismaAdapter(db)`: è¿™é‡Œæ˜¯å®˜æ–¹çš„[è½¬æ¥å™¨](https://next-auth.js.org/adapters/prisma)ï¼Œä¼ é€’ä¸€ä¸ª Prisma å®ä¾‹å³å¯
- `secret: process.env.SECRET`: è¿™é‡Œä½¿ç”¨åˆšåˆšè®¾ç½®çš„å¯†é’¥ç¯å¢ƒå˜é‡

```txt
.
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ Header.tsx
â”‚   â””â”€â”€ Layout.tsx
â”œâ”€â”€ lib
â”‚   â””â”€â”€ db
â”‚       â””â”€â”€ prisma.ts
â”œâ”€â”€ pages
â”‚   â”œâ”€â”€ _app.tsx
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ auth
â”‚   â”‚       â””â”€â”€ [...nextauth].ts
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ prisma
â”‚   â”œâ”€â”€ migrations
â”‚   â”‚   â”œâ”€â”€ 20221113032027_auth_base
â”‚   â”‚   â”‚   â””â”€â”€ migration.sql
â”‚   â”‚   â””â”€â”€ migration_lock.toml
â”‚   â””â”€â”€ schema.prisma
â”œâ”€â”€ styles
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ tsconfig.json
```

ok, ä¸‹é¢æˆ‘ä»¬å¯åŠ¨

```shell
npm run dev
```

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113093518.png)

ç™»å½•åï¼ŒæŸ¥çœ‹æ•°æ®åº“ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Prisma å®˜æ–¹æä¾›çš„ æ•°æ®è¿æ¥ UI ç®¡ç†æ¥æŸ¥çœ‹

```shell
npx prisma studio

Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Prisma Studio is up on http://localhost:5555
```

æ‰“å¼€: `http://localhost:5555`

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113153440.png)

ç‚¹å‡» "User"

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113153527.png)

ç‚¹å‡» "Account"

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113153607.png)

ç‚¹å‡» "Session"

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113153623.png)

æ­¤æ—¶æˆ‘ä»¬é€€å‡ºç™»å½•ï¼Œåˆ·æ–° Prisma Studio, æˆ–ç‚¹å‡»â€œFiltersâ€ å‰é¢çš„åˆ·æ–°æŒ‰é’®

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113153824.png)

å¯ä»¥çœ‹åˆ°ï¼Œ"Session" æ²¡æœ‰äº†

### é‚®ä»¶ç™»å½•

å¦‚æœä½¿ç”¨é‚®ä»¶ï¼Œé‚£ä¹ˆ NextAuth å¿…é¡»æœ‰è¿æ¥æ•°æ®åº“ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨è®¾ç½®äº† Prisma åï¼Œæ‰ä½¿ç”¨ Emailã€‚

Email çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª SMTP ä»£ç†æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ [QQ é‚®ç®±](https://wx.mail.qq.com/) è¿™åœ¨å›½å†…æ›´å¸¸ç”¨ï¼Œå¯ä»¥æ›´å¥½çš„ç†è§£é‚®ä»¶ç™»å½•çš„é€»è¾‘ã€‚

NextAuth çš„é‚®ä»¶æœåŠ¡æ˜¯ä½¿ç”¨ [Nodemailer](https://nodemailer.com/about/)

```shell
pnpm add nodemailer
```

`package.json`

```json
"dependencies": {
    ...
    "nodemailer": "^6.8.0",
	...
},
```

#### ç¯å¢ƒå˜é‡

`.env`

```txt
...

# Next Auth Email
EMAIL_SERVER_HOST=smtp.qq.com
EMAIL_SERVER_PORT=465
EMAIL_SERVER_USER=Your_qq_number@qq.com
EMAIL_SERVER_PASSWORD=Your_password
EMAIL_FROM=Your_qq_number@qq.com
```

- `EMAIL_SERVER_HOST` å’Œ `EMAIL_SERVER_PORT`
  è¿™æ˜¯[å®˜æ–¹](https://service.mail.qq.com/cgi-bin/help?id=28&no=167&subtype=1)çš„åœ°å€ `smtp.qq.com`, ç«¯å£å¯ä»¥ä½¿ç”¨ `465` æˆ– `587`

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113160039.png)

- `EMAIL_SERVER_USER`: å¡«å®Œæ•´çš„é‚®ç®±åï¼Œå¦‚ï¼š`123456789@qq.com`ï¼ŒåŒ…æ‹¬`@qq.com`éƒ¨åˆ†ã€‚
- `EMAIL_SERVER_PASSWORD`: å¯†ç ï¼Œè¿™é‡Œè¦å¡«æˆæƒç ï¼Œä¸æ˜¯æˆ‘ä»¬ç™»å½•çš„å¯†ç æ³¨æ„ï¼Œä¸‹é¢æˆ‘ä»¬ç”³è¯·ä¸€ä¸‹ã€‚
- `EMAIL_FROM`: æ˜¯æˆ‘ä»¬ï¼ˆå‘é€æ–¹ï¼‰çš„é‚®ä»¶åœ°å€ï¼Œè¿™é‡Œå’Œ `EMAIL_SERVER_USER` ç›¸åŒå°±å¥½

#### ç”³è¯·é‚®ç®±æˆæƒç 

1. ç™»å½• [QQ é‚®ç®±](https://wx.mail.qq.com/)
2. ç‚¹å‡» "è®¾ç½®"
   ![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113160431.png)

3. ç‚¹å‡» "å¸æˆ·"
   ![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113160527.png)

4. ç‚¹å‡» "å¼€å¯", æˆ‘ä»¬éœ€è¦ SMTP æœåŠ¡
   ![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113160632.png)

å¼€å¯æ—¶åº”è¯¥ä¼šéœ€è¦éªŒè¯ï¼Œè¿™é‡Œ QQ é‚®ç®±æ—¶ä½¿ç”¨æˆ‘ä»¬å‘çŸ­ä¿¡ç»™ QQ é‚®ç®±è®¤è¯ä¸­å¿ƒç›¸åº”çš„æ–‡å­—ï¼Œæ¥éªŒè¯

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113160840.png)

â—ï¸ å¦‚æœæˆ‘ä»¬æœ‰è®¾ç½®å¯†ä¿å·¥å…·çš„è¯ï¼Œç‚¹å‡» "éªŒä¸äº†,è¯•è¯•å…¶ä»–"æ¥ä½¿ç”¨ï¼ˆè¿™æ ·ä½ å°±ä¸ç”¨èŠ±çŸ­ä¿¡è´¹äº†ï¼‰

5. å½“å‘é€çŸ­ä¿¡åï¼Œç‚¹å‡» "æˆ‘å·²å‘é€"ï¼Œæ­¤æ—¶éªŒè¯æˆåŠŸä¼šå¼¹å‡ºæˆæƒç ä¿¡æ¯
   ![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113161338.png)

æˆ‘ä»¬å¤åˆ¶è¯¥æˆæƒç ã€‚æ·»åŠ åˆ° `EMAIL_SERVER_PASSWORD` åï¼Œæ³¨æ„è¯¥æˆæƒç å¯ä»¥å¤šæ¬¡ç”³è¯·

å¦‚æœæˆ‘ä»¬å¿˜è®°äº†æˆæƒç ï¼Œå¯ä»¥ç‚¹å‡» "ç”Ÿæˆæˆæƒç " å†æ¬¡éªŒè¯ç”³è¯·

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113163217.png)

#### é…ç½® NextAuth

```ts
import { NextApiHandler } from "next";
import { NextAuthOptions } from "next-auth";
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import GitHubProvider from "next-auth/providers/github";
import EmailProvider from "next-auth/providers/email";
import NextAuth from "next-auth/next";
import { db } from "~/lib/db/prisma";

const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(db),
  secret: process.env.SECRET,
  providers: [
    GitHubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
    EmailProvider({
      server: {
        host: process.env.EMAIL_SERVER_HOST,
        port: process.env.EMAIL_SERVER_PORT,
        auth: {
          user: process.env.EMAIL_SERVER_USER,
          pass: process.env.EMAIL_SERVER_PASSWORD,
        },
      },
      from: process.env.EMAIL_FROM,
    }),
  ],
};

const authHandler: NextApiHandler = (req, res) =>
  NextAuth(req, res, authOptions);

export default authHandler;
```

å®˜æ–¹æ›´è¯¦ç»†è¯´æ˜: https://next-auth.js.org/providers/email

#### ç™»å½•

1. å¯åŠ¨æœåŠ¡

```shell
npm run dev
```

2. ç‚¹å‡» "ç™»å½•"
   ![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113163636.png)

å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ "é‚®ç®±ç™»å½•" æ–¹å¼äº†ï¼ˆç™»å½•æ–¹å¼çš„é¡ºåºæ¥è‡ª NextAuth Providers é…ç½®çš„é¡ºåºï¼‰

3. è¿™é‡Œè¾“å…¥ä¸€ä¸ªæµ‹è¯•é‚®ç®±ï¼Œç‚¹å‡» "Sign in with Email"
   ä½ ä¼šè·³è½¬åˆ° `/api/auth/verify-request` é¡µé¢ï¼Œè¿™æ˜¯ NextAuth é»˜è®¤çš„

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113163907.png)

â—ï¸ æˆ‘è¿™é‡Œçš„æµ‹è¯•é‚®ä»¶åœ°å€å’Œä¹‹å‰çš„ Github ç™»å½•ç”¨æˆ·çš„é‚®ä»¶ä¸€æ ·ï¼Œå¦‚æœä½ çš„ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆä¼šæ˜¯ä¸€ä¸ªæ–°çš„ç”¨æˆ·

å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ· `emailVerified` æ˜¯ç©ºçš„
![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113175236.png)
è€Œ `VerificationToken` ä¸­å·²ç»æœ‰ä¸€æ¡éªŒè¯ä¿¡æ¯äº†
![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113175458.png)

4. åˆ°æˆ‘ä»¬çš„æµ‹è¯•é‚®ç®±ä¸­ï¼Œä¼šæœ‰ä¸€ä»½æ¥è‡ª `localhost:3000` æ ‡é¢˜çš„é‚®ä»¶
   å¦‚æœæ²¡æ‰¾åˆ°çš„è¯ï¼Œè¯·åœ¨ åƒåœ¾é‚®ä»¶ä¸­ç¡®è®¤ä¸‹ï¼Œå¦åˆ™å¯èƒ½å°±æ˜¯é…ç½®æœ‰é”™è¯¯

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113164318.png)

5. ç‚¹å‡» "Sign in"
   ![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113164431.png)

6. æŸ¥çœ‹æ•°æ®åº“

```shell
npx prisma studio
```

å¯ä»¥çœ‹åˆ° `emailVerified` å·²ç»æœ‰å€¼äº†ï¼Œæ˜¯éªŒè¯å®Œæˆçš„æ—¶é—´

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113175601.png)

ok, æˆ‘ä»¬æ¥æ¢³ç†ä¸‹ NextAuth é‚®ä»¶ç™»å½•çš„é€»è¾‘

- æ²¡æœ‰æ³¨å†Œï¼Œç”¨æˆ·ç¬¬ä¸€æ¬¡ç™»å½•å³ä¼šåˆ›å»ºæ–°ç”¨æˆ·
- æ¯æ¬¡é‚®ä»¶ç™»å½•ï¼Œéƒ½éœ€è¦å‘é€é‚®ä»¶ï¼ŒéªŒè¯
- é‚®ä»¶ç™»å½•ä¸éœ€è¦ç”¨æˆ·å¯†ç 

å…¶å®æˆ‘ä»¬æ›´å¸¸è§çš„æ˜¯

- é¦–æ¬¡ç™»å½•ï¼ˆå°±æ˜¯æ³¨å†Œï¼‰ï¼Œå‘é€éªŒè¯é‚®ä»¶ï¼Œç”¨æˆ·ç‚¹å‡»éªŒè¯é“¾æ¥
- è·³è½¬åˆ°ç”¨æˆ·å¸æˆ·ä¿¡æ¯ç¡®è®¤é¡µé¢ï¼Œç¡®è®¤è´¦å·ï¼Œå¡«å†™å¯†ç ï¼Œå®Œæˆé¦–æ¬¡ç”¨æˆ·ç™»å½•
- ç¬¬äºŒæ¬¡ç™»å½•ï¼Œç›´æ¥è¾“å…¥è´¦å·ï¼Œå¯†ç ï¼Œå®Œæˆç™»å½•

ğŸ¤ª è¿™è¦ä¸‹ä¸€ä¸ªæ•™ç¨‹äº†

### åŸºç¡€ Blog

æˆ‘ä»¬è¦å®Œæˆ

- åˆ›å»ºæ–‡ç« 
- æ–‡ç« å‘å¸ƒ
- æ–‡ç« è¯¦æƒ…
- æŸ¥è¯¢æ–‡ç« 
- æ–‡ç« åˆ é™¤

#### æ–‡ç« è¡¨

1. åˆ›å»ºæ–‡ç« è¡¨ `prisma/schema.prisma`

```txt
model User {
	id            String    @id @default(cuid())
	...
	Post     Post[]

	@@map("users")
}

...

model Post {
	id        String   @id @default(cuid())
	title     String
	content   String?
	published Boolean  @default(false)
	createdAt DateTime @default(now()) @map(name: "created_at")
	updatedAt DateTime @updatedAt @map(name: "updated_at")
	authorId  String?

	author User? @relation(fields: [authorId], references: [id])

	@@map("posts")
}
```

è¿™é‡Œè¦å…³è” `User` å’Œ `Post` æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»

2. å°†æ–°çš„ Schema æ˜ å°„åˆ°æ•°æ®åº“

```shell
ğŸ¤™  my-blog git:(main) npx prisma migrate dev --name posts

Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "my-blog", schema "public" at "localhost:5432"

Applying migration `20221113103115_posts`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20221113103115_posts/
    â””â”€ migration.sql

Your database is now in sync with your schema.

âœ” Generated Prisma Client (4.6.1 | library) to ./node_modules/.pnpm/registry.npmmirror.com+@prisma+client@4.6.1_prisma@4.6.1/node_module
s/@prisma/client in 98ms
```

æ–‡ä»¶æ ‘

```txt
.
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ Header.tsx
â”‚   â””â”€â”€ Layout.tsx
â”œâ”€â”€ lib
â”‚   â””â”€â”€ db
â”‚       â””â”€â”€ prisma.ts
â”œâ”€â”€ pages
â”‚   â”œâ”€â”€ _app.tsx
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â””â”€â”€ auth
â”‚   â”‚       â””â”€â”€ [...nextauth].ts
â”‚   â””â”€â”€ index.tsx
â”œâ”€â”€ .env
â”œâ”€â”€ .gitignore
â”œâ”€â”€ next-env.d.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ postcss.config.js
â”œâ”€â”€ prisma
â”‚   â”œâ”€â”€ migrations
â”‚   â”‚   â”œâ”€â”€ 20221113032027_auth_base
â”‚   â”‚   â”‚   â””â”€â”€ migration.sql
â”‚   â”‚   â”œâ”€â”€ 20221113103115_posts
â”‚   â”‚   â”‚   â””â”€â”€ migration.sql
â”‚   â”‚   â””â”€â”€ migration_lock.toml
â”‚   â””â”€â”€ schema.prisma
â”œâ”€â”€ styles
â”‚   â””â”€â”€ globals.css
â”œâ”€â”€ tailwind.config.js
â””â”€â”€ tsconfig.json
```

![Next NextAuth Prisma Blog](/static/images/next-auth-prisma-tutorial/20221113183527.png)

Come Soon!
