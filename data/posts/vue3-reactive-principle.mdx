---
title: Vue3 reactivity åŸç†
description: vue3 å“åº”å¼çš„å®ç°åŸç†çš„è§£è¯»
tags: Vue, å“åº”å¼
badges: note
publicAt: "2022-03-06"
---

## @vue/reactivity@3.0.0-alpha.0

è¿™é‡Œå…ˆçœ‹çš„æ˜¯æœ€æ—©æœŸçš„ä»£ç ï¼Œç»“æ„ä¼šæ›´å®¹æ˜“è¯»äº›ï¼Œä¸‹é¢çš„æ–‡ç« ä¸æ˜¯ç›´æ¥çœ‹æºç ï¼Œè€Œæ˜¯ç”± vue reativeity çš„å‡ºå£ api æ¥è¿›å…¥ï¼Œè¯•ç€å®ç°è¯¥æ¥å£ï¼ˆå¹¶éç©å»å®ç°ï¼‰

## demo.html

```jsx
<script type="module">
  import { reactive, effect } from "./simple-reactivity.js";

  const root = document.querySelector("#root");
  const btnName = document.querySelector("#btn_name");
  const btnAge = document.querySelector("#btn_age");
  const inputName = document.querySelector("#input_name");

  const user = reactive({
    name: "å¼ ä¸‰",
    age: 27,
  });

  inputName.value = user.name;

  effect(() => {
    root.innerHTML = `<h1>${user.name}---${user.age}</h1>`;
  });

  effect(() => {
    console.log(user.age);
  });

  inputName.oninput = function (event) {
    user.name = event.target.value;
  };

  btnAge.onclick = function () {
    user.age += 1;
  };
</script>

<div id="root"></div>
<input type="text" id="input_name" placeholder="åå­—" />
<button id="btn_age">å¹´é¾„ + 1</button>
```

æˆ‘ä»¬è¿™é‡Œè¦å®ç°çš„æ˜¯ reactive å’Œ effectï¼Œè™½ç„¶æˆ‘ä»¬ç›´æ¥åœ¨ vue core ä¸­æ²¡æœ‰ effect æ¥å£ï¼Œä½†æ˜¯ watchï¼Œcomputed å†…éƒ½æ˜¯ä½¿ç”¨äº† effectï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å…³æ³¨ effectï¼ˆç±»ä¼¼ react effect çš„æ•ˆæœï¼‰

## reactive

```jsx
const user = reactive({
  name: "å¼ ä¸‰",
  age: 27,
});
```

vue2 ä¸­å“åº”å¼çš„å®ç°ä¾é å¯¹è±¡çš„æè¿°ï¼ˆ[defineProperties](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperties)ï¼‰

`get`

ä½œä¸ºè¯¥å±æ€§çš„ getter å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ getter åˆ™ä¸º`undefined`ã€‚å‡½æ•°è¿”å›å€¼å°†è¢«ç”¨ä½œå±æ€§çš„å€¼ã€‚**é»˜è®¤ä¸º Â `undefined`**

`set`

ä½œä¸ºå±æ€§çš„ setter å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ setter åˆ™ä¸º`undefined`ã€‚å‡½æ•°å°†ä»…æ¥å—å‚æ•°èµ‹å€¼ç»™è¯¥å±æ€§çš„æ–°å€¼ã€‚**é»˜è®¤ä¸º Â `undefined`**

<aside>
ğŸ›ï¸ å…·ä½“ä¸ºå•¥ï¼Ÿæ›´å¿«ï¼Œå¼€é”€æ›´å°ï¼ˆè‡ªå·±æœç´¢ä¸‹æŠŠï¼‰

</aside>

vue3 ä½¿ç”¨äº† Proxyï¼ˆReflect, Map, Set, WeakMap, WeakSetï¼‰éœ€è¦å…ˆäº†è§£ä¸€ä¸‹

[Proxy å’Œ Reflect](https://zh.javascript.info/proxy)

[Map and Setï¼ˆæ˜ å°„å’Œé›†åˆï¼‰](https://zh.javascript.info/map-set)

[WeakMap and WeakSetï¼ˆå¼±æ˜ å°„å’Œå¼±é›†åˆï¼‰](https://zh.javascript.info/weakmap-weakset)

ok, å¼€å§‹

å…ˆæƒ³ä¸€ä¸‹ï¼Œreactive çš„ç±»å‹ï¼ˆtypescriptï¼‰

```jsx
function reactive<T extends object>(target: T): ReactiveTarget
```

<aside>
ğŸ›ï¸ get, set å°±æ˜¯ Proxy é‡Œçš„ handlerï¼Œæˆ‘ä»¬è¿™é‡Œå¯ä»¥å…ˆä¸ç®¡ï¼ˆè¿™é‡Œä»…ä»…æ˜¯ä¸€ä¸ªå‡½æ•°å€¼ï¼Œåœ¨ProxyTargetè·å–å±æ€§æˆ–èµ‹å€¼ç­‰æ“ä½œçš„æ—¶å€™ï¼Œæ‹¦æˆªå‡½æ•°æ‰ä¼šæ‰§è¡Œï¼‰

</aside>

```jsx
function get(target, key, receiver) {
  // track() åšäº›æ‹¦æˆª
  return Reflect.get(target, key, receiver);
}

function set(target, key, value, receiver) {
  // trigger() åšäº›æ‹¦æˆª
  return Reflect.set(target, key, value, receiver);
}
```

```jsx
function reactive(target) {
  return new Proxy(target, {
    get,
    set,
  });
}
```

ä¸ºäº†æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬åŒä¸€ä¸ª targetï¼Œæ²¡å¿…è¦æ¯æ¬¡éƒ½å»åˆ›å»º proxyï¼Œå¯ä»¥æä¸ªç¼“å­˜å˜›

```jsx
const rawToReactive = new WeakMap(); // taret: reactiveTarget
const reactiveToRaw = new WeakMap(); // reactiveTarget: target

function isObject(val) {
  return val != null && typeof val === "object";
}

export function reactive(target) {
  return createReactiveObject(target, rawToReactive, reactiveToRaw, {
    get,
    set,
  });
}

function createReactiveObject(target, toProxy, toRaw, handlers) {
  if (!isObject(target)) {
    // ä¸æ˜¯å¯¹è±¡ä¸å¤„ç†
    return target;
  }
  let observed = toProxy.get(target);
  if (observed != undefined) {
    return observed;
  }
  if (toRaw.has(target)) {
    return target;
  }
  observed = new Proxy(target, handlers);
  toProxy.set(target, observed);
  toRaw.set(observed, target);
  return observed;
}
```

![reactive](/static/images/Xnip2022-03-06_09-01-08.jpg)

å…¶å®è¿™é‡Œå¹¶æ²¡æœ‰å®Œæˆæ˜¯å“åº”ï¼Œæˆ‘ä»¬åªæ˜¯å°† target åˆ›å»ºäº†ä¸€ä¸ª proxyï¼Œè¿”å›ã€‚è€Œå…·ä½“çš„æ‹¦æˆªæ‰§è¡Œæ˜¯ reactiveTarget çš„ä½¿ç”¨

```jsx
const user = reactive({
  name: "å¼ ä¸‰",
  age: 27,
});
user.name; // get => "å¼ ä¸‰"
user.age = user.age + 1; // set => true; 28
```

okï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆä¸ç”¨å¤„ç†äº†ï¼Œä»æ•°æ®æ¥è¯´ï¼Œè¿™ä»¥åŠæ˜¯æˆ‘ä»¬è¦çš„ç»“æœäº†ï¼Œè€Œä¹‹åçš„å“åº”æ˜¯å’Œæ‰§è¡Œæœ‰å…³äº†ï¼Œä¹Ÿå°±æ˜¯ setï¼Œget ç­‰ handlers ä¸­å¦‚ä½•æ‹¦æˆªç­‰æ“ä½œ

## effect

```jsx
function effect()
```
