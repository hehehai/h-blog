---
title: åœ¨ Vercel éƒ¨ç½²æ— å¤´æµè§ˆå™¨å®ç°ç½‘é¡µæˆªå›¾
description: å¦‚ä½•ä½¿ç”¨å°† Nextjs ä¸­çš„æ— å¤´æµè§ˆå™¨(headless)éƒ¨ç½²åœ¨ Vercel æˆ–å…¶ä»– AWS-Lambdaã€‚
tags: Vercel,Headless,Nextjs,AWS
badges: å®è·µ
publicAt: "2024-01-16"
---

æœ€è¿‘åœ¨åš OpenGraph ç›¸å…³çš„å·¥ä½œï¼Œéœ€è¦æ ¹æ®ç½‘å€è¿”å›é¡µé¢çš„é¦–å±æˆªå›¾ï¼Œæ¯«æ— ç–‘é—®æ— å¤´æµè§ˆå™¨å·²å‘å±•å¤šå¹´ï¼Œå·²è¶³å¤Ÿå¯é ï¼Œç›´æ¥ä½¿ç”¨ Nodejs é›†æˆ [Puppeteer](https://pptr.dev/) å°±å¥½ã€‚

<FAQBox title="æ— å¤´æµè§ˆå™¨æ˜¯ä»€ä¹ˆï¼Ÿ">
æ— å¤´æµè§ˆå™¨ï¼ˆHeadless Browserï¼‰æ˜¯ä¸€ç§æ²¡æœ‰å›¾å½¢ç”¨æˆ·ç•Œé¢ï¼ˆGUIï¼‰çš„ç½‘ç»œæµè§ˆå™¨ã€‚å®ƒèƒ½å¤Ÿæ‰§è¡Œä¸å¸¸è§„æµè§ˆå™¨ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†æ²¡æœ‰å¯è§çš„çª—å£æˆ–ç•Œé¢ã€‚æ— å¤´æµè§ˆå™¨å¯ä»¥åœ¨åå°è¿è¡Œï¼ŒåŠ è½½å’Œæ¸²æŸ“ç½‘é¡µï¼Œæ‰§è¡ŒJavaScriptä»£ç ï¼Œå¹¶æä¾›å¯¹ç½‘é¡µå†…å®¹çš„è®¿é—®å’Œæ“ä½œã€‚å®ƒå¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·ä¸ç½‘é¡µçš„äº¤äº’ï¼Œå¦‚ç‚¹å‡»é“¾æ¥ã€å¡«å†™è¡¨å•ã€æäº¤æ•°æ®ç­‰ã€‚é€šè¿‡æ— å¤´æµè§ˆå™¨ï¼Œå¼€å‘äººå‘˜å¯ä»¥ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬æ¥æµ‹è¯•ç½‘ç«™çš„åŠŸèƒ½ã€æ‰§è¡Œç½‘ç»œçˆ¬è™«ä»»åŠ¡æˆ–è¿›è¡Œå…¶ä»–ä¸æµè§ˆå™¨ç›¸å…³çš„è‡ªåŠ¨åŒ–æ“ä½œã€‚

- [Puppeteer](https://pptr.dev/): ä¸€ä¸ª Node.js åº“ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªé«˜çº§ API æ¥é€šè¿‡ DevTools åè®®æ§åˆ¶ Chrome/Chromium
- [Playwright](https://playwright.dev/): æ”¯æŒå¯¹ç°ä»£ Web åº”ç”¨ç¨‹åºè¿›è¡Œå¯é çš„ç«¯åˆ°ç«¯æµ‹è¯•ã€‚
- [Crawlee](https://crawlee.dev/): Web æŠ“å–å’Œæµè§ˆå™¨è‡ªåŠ¨åŒ–åº“
</FAQBox>

ä½†æ˜¯ï¼Œè¿™åœ¨ [Nextjs](https://nextjs.org/) çš„ [Vercel](https://vercel.com) éƒ¨ç½²é‡åˆ°äº†é—®é¢˜ï¼Œå®ƒå¤±è´¥äº†ï¼

![Vercel limit 50M](/static/images/vercel-deploy-headless/20240116092144.jpg)

å¥½å§ï¼Œå‡ºé—®é¢˜äº†! äºæ˜¯æˆ‘æ‰¾åˆ°äº†è¿™ä¸ª https://github.com/orgs/vercel/discussions/103

çœ‹æ¥è¿™ä¸ªé—®é¢˜å·²ç»è›®å¤šäººé‡åˆ°äº†ï¼Œçœ‹åˆ°æåˆ°çš„è§£å†³æ–¹æ¡ˆæœ‰è¿™ä¸ª

```txt
Traced Next.js server files in: 423.26ms
--
23:27:46.148 | Warning: Max serverless function size of 50 MB compressed or 250 MB uncompressed reached
23:27:46.148 | Serverless Function's page: api/get-mls-entries.js
23:27:46.151 | Large Dependencies                  Uncompressed size  Compressed size
23:27:46.151 | node_modules/chrome-aws-lambda/bin            49.6 MB          49.5 MB
23:27:46.151 | node_modules/next/dist                        3.09 MB           957 kB
23:27:46.151 | node_modules/puppeteer-core/lib                536 kB           137 kB
23:27:46.151 | node_modules/lodash/lodash.js                  544 kB          96.4 kB
23:27:46.151 | node_modules/parse5/dist                       589 kB          89.5 kB
```

[chrome-aws-lambda](https://github.com/alixaxel/chrome-aws-lambda): AWS Lambda å’Œ Google Cloud å‡½æ•°çš„äºŒè¿› Chromium

å¤§å°åœ¨ 50M å†…ï¼Œå¾ˆæ¥è¿‘äº†ï¼Œè¿˜æœ‰ä¸ªé—®é¢˜æ˜¯ aws-lambda å·²ç»å¤šå¹´ä¸ç»´æŠ¤äº†ï¼Œå†…æ ¸ç‰ˆæœ¬æœ‰äº›æ—§äº†ï¼Œæˆ‘ä»¬æ¥æƒ³æƒ³å…¶ä»–åŠæ³•ã€‚

## è¿œç¨‹å†…æ ¸

[@sparticuz/chromium](https://github.com/Sparticuz/chromium)ï¼šAWS Lambda çš„åç»§ç»´æŠ¤ç‰ˆ

åœ¨æ–‡æ¡£ç§æ‰¾åˆ°äº†è¿™ä¸ª

> If your vendor does not allow large deploys (`chromium.br`Â is 50+ MB), you'll need to host theÂ `chromium-v#-pack.tar`Â separately and use theÂ [`@sparticuz/chromium-min`Â package](https://github.com/Sparticuz/chromium#-min-package).
>
> å¦‚æœæ‚¨çš„ä¾›åº”å•†ä¸å…è®¸å¤§å‹éƒ¨ç½²(chromium.br ä¸º 50+MB)ï¼Œæ‚¨å°†éœ€è¦å•ç‹¬æ‰˜ç®¡ Chrome-v#-Pack.tar å¹¶ä½¿ç”¨

```shell
npm install --save @sparticuz/chromium-min@$CHROMIUM_VERSION
```

ä½¿ç”¨å•ç‹¬æ‰˜ç®¡çš„åŒ…

```js
const browser = await puppeteer.launch({
  args: chromium.args,
  defaultViewport: chromium.defaultViewport,
  executablePath: await chromium.executablePath(
    "https://www.example.com/chromiumPack.tar"
  ),
  headless: chromium.headless,
});
```

### æ€è·¯

![lambda headless](/static/images/vercel-deploy-headless/20240116105515.jpg)

**å¼€å‘æ¨¡å¼**
å¼€å‘ç›´æ¥ä½¿ç”¨æœ¬åœ°åŒ…ï¼ˆä½ ç”µè„‘ä¸Šçš„ Chrome æµè§ˆå™¨ï¼‰ï¼Œä¸åŒç³»ç»Ÿçš„æœ¬åœ°åŒ…è·¯å¾„ä¸åŒã€‚

**ç”Ÿäº§æ¨¡å¼**
ä½¿ç”¨è¿œç¨‹ Chromium äºŒè¿›åˆ¶åŒ…ï¼Œå®ƒæ˜¯ä¸€äº’è”ç½‘æ–‡ä»¶åœ°å€ï¼Œå»ºè®®ä½¿ç”¨ github çš„å…¬å¼€åŒ…åœ°å€ï¼Œå¦åˆ™ç§æœ‰åœ°å€è¦æ³¨æ„æµé‡é—®é¢˜ã€‚

## æ­å»º

åˆ›å»º Nextjs é¡¹ç›®ï¼Œåˆ›å»ºå®Œæ¯•åå®‰è£…éœ€è¦çš„ä¾èµ–

å¼€å‘ä¾èµ–

```shell
npm install @sparticuz/chromium-min@119 puppeteer-core@21
```

å®‰è£…å®Œæ¯•å

```json
{
  "dependencies": {
    "@sparticuz/chromium-min": "^119.0.2",
    "puppeteer-core": "^21.6.1"
  }
}
```

åˆ›å»ºæ¥å£è·¯ç”± `/src/app/try/route.js`

```js
// æœ¬åœ° Chrome æ‰§è¡ŒåŒ…è·¯å¾„
const localExecutablePath =
  process.platform === "win32"
    ? "C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe"
    : process.platform === "linux"
    ? "/usr/bin/google-chrome"
    : "/Applications/Google Chrome.app/Contents/MacOS/Google Chrome";

// è¿œç¨‹æ‰§è¡ŒåŒ…
const remoteExecutablePath =
  "https://github.com/Sparticuz/chromium/releases/download/v119.0.2/chromium-v119.0.2-pack.tar";

// è¿è¡Œç¯å¢ƒ
const isDev = process.env.NODE_ENV === "development";
```

åœ¨â€œå¼€å‘æ¨¡å¼â€ä¸‹ä½¿ç”¨æœ¬åœ° Chrome çš„æ‰§è¡Œè·¯å¾„ï¼Œå¦åˆ™ä½¿ç”¨è¿œç¨‹åŒ…æ‰§è¡Œè·¯å¾„ã€‚

![local headless chromium core](/static/images/vercel-deploy-headless/20240116112349.png)

æ›´å¤šè¿œç¨‹æ‰§è¡ŒåŒ…ï¼Œå¯ä»¥æŸ¥çœ‹ [Sparticuz/chromium](https://github.com/Sparticuz/chromium/releases)

![remote headless chromium core](/static/images/vercel-deploy-headless/20240116112613.png)

```js
export async function GET() {
  let browser = null;
  try {
    // å¼•å…¥ä¾èµ–
    const chromium = require("@sparticuz/chromium-min");
    const puppeteer = require("puppeteer-core");

    // å¯åŠ¨
    browser = await puppeteer.launch({
      args: isDev ? [] : chromium.args,
      defaultViewport: { width: 1920, height: 1080 },
      executablePath: isDev
        ? localExecutablePath
        : await chromium.executablePath(remoteExecutablePath),
      headless: chromium.headless,
    });

    // æ‰“å¼€é¡µé¢
    const page = await browser.newPage();
    // ç­‰å¾…é¡µé¢èµ„æºåŠ è½½å®Œæ¯•
    await page.goto("https://hehehai.cn", {
      waitUntil: "networkidle0",
      timeout: 100000,
    });
    // æ‰“å°é¡µé¢æ ‡é¢˜
    console.log("page title", await page.title());
    const blob = await page.screenshot({ type: "png" });

    const headers = new Headers();

    headers.set("Content-Type", "image/png");
    headers.set("Content-Length", blob.length.toString());

    // å“åº”é¡µé¢æˆªå›¾
    return new NextResponse(blob, { status: 200, statusText: "OK", headers });
  } catch (err) {
    console.log(err);
    return NextResponse.json(
      { error: "Internal Server Error" },
      { status: 500 }
    );
  } finally {
    // é‡Šæ”¾èµ„æº
    await browser.close();
  }
}
```

- `args: isDev ? [] : chromium.args`: â€œå¼€å‘æ¨¡å¼â€ä¸éœ€è¦è®¾ç½®æ‰§è¡ŒåŒ…çš„å‘½ä»¤è¡Œå‚æ•°
- `executablePath`: ç”¨æ¥é…ç½®æ‰§è¡ŒåŒ…è·¯å¾„
  - â€œå¼€å‘æ¨¡å¼â€ `localExecutablePath`
  - â€œéå¼€å‘æ¨¡å¼â€ `await chromium.executablePath(remoteExecutablePath)`

è¿™é‡Œä¸è¿‡å¤šä»‹ç» Puppeteer çš„è¿è¡Œé…ç½®äº†å°±ï¼Œæ›´ç»†èŠ‚çš„ä¼˜åŒ–é…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£

å¯åŠ¨ç¨‹åº

```shell
npm run dev


> headless-try@0.1.0 dev
> next dev

   â–² Next.js 14.0.4
   - Local:        http://localhost:3000
   - Environments: .env.local

 âœ“ Ready in 2s
```

è®¿é—® [`http://localhost:3000/try`](http://localhost:3000/try)

ğŸ¤¨ å‡ºç°é”™è¯¯

![nextjs headless pkg error](/static/images/vercel-deploy-headless/20240116113014.png)

```txt
 â¨¯ ./node_modules/puppeteer-core/lib/cjs/puppeteer/cdp/EmulationManager.js
Module parse failed: Unexpected token (180:32)
|                 private: true,
|                 access: {
>                     has: (obj)=>#applyViewport in obj,
|                     get: (obj)=>obj.#applyViewport
|                 },

Import trace for requested module:
./node_modules/puppeteer-core/lib/cjs/puppeteer/cdp/EmulationManager.js
./node_modules/puppeteer-core/lib/cjs/puppeteer/cdp/cdp.js
./node_modules/puppeteer-core/lib/cjs/puppeteer/puppeteer-core.js
./src/app/try/route.js
```

### require åŒ…å¼•å…¥

ä½ ä¼šå‘ç°æˆ‘ä»¬ä½¿ç”¨çš„ä¾èµ–åŒ…æ˜¯ä½¿ç”¨ `require` æ–¹å¼å¼•å…¥çš„ï¼ŒNextjs é»˜è®¤ä¼˜åŒ–äº†ä¸€éƒ¨åˆ† [Nodejs åŒ…](https://github.com/vercel/next.js/blob/canary/packages/next/src/lib/server-external-packages.json)ï¼Œè¿™äº›ä½¿ç”¨ `require` å¼•å…¥æ˜¯ä¼šè‡ªåŠ¨å¤„ç†çš„ï¼Œå¥½åœ¨ Nextjs æä¾›äº†é…ç½®ã€‚

`next.config.js`

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    serverComponentsExternalPackages: [
      "puppeteer-core",
      "@sparticuz/chromium-min",
    ],
  },
};

module.exports = nextConfig;
```

[`serverComponentsExternalPackages`](https://nextjs.org/docs/app/api-reference/next-config-js/serverComponentsExternalPackages): å¦‚æœä¾èµ–é¡¹ä½¿ç”¨ Nodejs ç‰¹å®šåŠŸèƒ½ï¼Œæ‚¨å¯ä»¥é€‰æ‹©ä»æœåŠ¡å™¨ç»„ä»¶æ†ç»‘ä¸­é€‰æ‹©é€€å‡ºç‰¹å®šä¾èµ–é¡¹å¹¶ä½¿ç”¨æœ¬æœº NodejsÂ `require`Â ã€‚

ä¿å­˜åï¼Œé‡æ–°å¯åŠ¨æœåŠ¡ï¼Œè®¿é—® [`http://localhost:3000/try`](http://localhost:3000/try)

![hehehai blog screenshot](/static/images/vercel-deploy-headless/20240116114019.png)

```shell
...

 âœ“ Ready in 1710ms
 âœ“ Compiled /try in 224ms (40 modules)
page title Hehehai @ä¸€å—æœ¨å¤´ - å…¨æ ˆå¼€å‘ï¼Œä¸“æ³¨äºå‰ç«¯åº”ç”¨ç¨‹åºå’Œç”¨æˆ·ç•Œé¢è®¾è®¡.
```

ğŸ¥³ğŸ¥³ğŸ¥³ é€Ÿåº¦è¿˜æ˜¯å¾ˆå¿«çš„

### éƒ¨ç½² vercel

Fork [headless-try repo](https://github.com/hehehai/headless-try)

ç™»å½• [verlcel](https://vercel.com) ç™»å½•åï¼Œè¿›å…¥ Dashboardï¼Œåˆ›å»ºé¡¹ç›®

![vercel project create](/static/images/vercel-deploy-headless/20240116121328.png)

é€‰æ‹© **headless-try**

![vercel project deploy](/static/images/vercel-deploy-headless/20240116121419.png)

ç‚¹å‡» **Deploy** æŒ‰é’®

![vercel project dashboard](/static/images/vercel-deploy-headless/20240116121503.png)

éƒ¨ç½²æˆåŠŸåï¼Œè®¿é—® **Domains** ç‚¹å‡» **Blog screenshot** é“¾æ¥ï¼ŒğŸ¤© ç½‘é¡µæˆªå›¾å†æ¬¡ç”Ÿæˆï¼Œå¯ä»¥çœ‹åˆ°ï¼Œéå¸¸å¿«ï¼

![hehehai vercel blog](/static/images/vercel-deploy-headless/20240116121721.png)

## åœ¨ Cloudflare ä¸­ä½¿ç”¨ headless

![cloudflare headless](/static/images/vercel-deploy-headless/20240116122553.png)

```js
import puppeteer from "@cloudflare/puppeteer";

export default {
    async fetch(request: Request, env: Env): Promise<Response> {
        const { searchParams } = new URL(request.url);
        let url = searchParams.get("url");
        let img: Buffer;
        if (url) {
            const browser = await puppeteer.launch(env.MYBROWSER);
            const page = await browser.newPage();
            await page.goto(url);
            img = (await page.screenshot()) as Buffer;
            await browser.close();
            return new Response(img, {
                headers: {
                    "content-type": "image/jpeg",
                },
            });
        } else {
            return new Response(
                "Please add the ?url=https://example.com/ parameter"
            );
        }
    },
};
```

ğŸ¥³ å¥½æ¶ˆæ¯ï¼š[Workers Browser Rendering API enters open beta](https://blog.cloudflare.com/browser-rendering-open-beta)

ğŸ«  åæ¶ˆæ¯ï¼šè¿˜åœ¨å†…æµ‹ä¸­, å¿«æ¥ç”³è¯· [Add yourself to the waitlist](https://www.cloudflare.com/lp/workers-browser-rendering-api/)

## Browserless

é™¤æ­¤å¤–ï¼Œè¿˜æœ‰ç§ç‹¬ç‰¹çš„æ–¹å¼ï¼ŒPuppeteer å…è®¸é€šè¿‡ browserWSEndpoint é€‰é¡¹æŒ‡å®š chrome çš„è¿œç¨‹ä½ç½®ï¼Œå°±åƒè¿™æ ·

```js
const browser = await puppeteer.connect({
  browserWSEndpoint: "ws://localhost:3000",
});
```

æˆ‘ä»¬éœ€è¦ä¸€ä¸ª ws çš„ chrome è¿œç¨‹æœåŠ¡æ¥è¢«è°ƒç”¨ã€‚ å¥½åœ¨å®ƒå·²ç»å‡ºç°äº† ğŸ‘ğŸ‘ğŸ‘ [Browserless](https://www.browserless.io/)ï¼

![Browserless site](/static/images/vercel-deploy-headless/browerless-site.jpg)

> Browserless å…è®¸è¿œç¨‹å®¢æˆ·ç«¯è¿æ¥å¹¶æ‰§è¡Œæ— å¤´å·¥ä½œï¼Œæ‰€æœ‰è¿™äº›éƒ½åœ¨ Docker å†…éƒ¨ã€‚å®ƒæ”¯æŒæ ‡å‡†çš„ã€æœªåˆ†å‰çš„ Puppeteer å’Œ Playwright åº“ï¼Œå¹¶ä¸ºæ•°æ®æ”¶é›†ã€PDF ç”Ÿæˆç­‰å¸¸è§æ“ä½œæä¾›åŸºäº REST çš„ APIã€‚

å®ƒæ˜¯[å¼€æº](https://github.com/browserless/browserless)çš„ï¼Œå¯ä»¥ä½¿ç”¨ Docker éƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šã€‚

```js
// Next.js API route support: https://nextjs.org/docs/api-routes/introduction
import type { NextApiRequest, NextApiResponse } from 'next'
import puppeteer from 'puppeteer-core'

type Json = {
  message: string
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<Json | Buffer>
) {
  const { searchParams } = new URL(
    req.url as string,
    `http://${req.headers.host}`
  )
  const url = searchParams.get('url')

  if (!url) {
    return res
      .status(400)
      .json({ message: `A ?url query-parameter is required` })
  }

  const browser = await puppeteer.connect({
    browserWSEndpoint: `wss://chrome.browserless.io?token=${process.env.BLESS_TOKEN}`,
  })

  const page = await browser.newPage()
  await page.setViewport({ width: 1920, height: 1080 })
  await page.goto(url)

  return res.status(200).send(await page.screenshot({type: 'png'}))
}
```

## å‚è€ƒ

- [Generate screenshots of your code with a serverless function](https://blog.maximeheckel.com/posts/creating-beautiful-screenshots-source-code-with-serverless-function/)
- [How to use headless Chrome in serverless functions with a 50MB limit](https://www.stefanjudis.com/blog/how-to-use-headless-chrome-in-serverless-functions/)
- [next-api-og-image](https://github.com/neg4n/next-api-og-image)
- [Exceeding size limits (50mb) for Serverless Functions](https://github.com/orgs/vercel/discussions/103)
- [Sparticuz/chromium](https://github.com/Sparticuz/chromium)
- [Oustro/portfoliwoah](https://github.com/Oustro/portfoliwoah/blob/a0912026a898dad78d90fe0f4793e45563cce451/app/api/posts/screenshot/route.ts)
- [browerless puppeteer](https://github.com/browserless/vercel-puppeteer)
