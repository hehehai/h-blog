---
title: Next + NextAuth + Password è®¤è¯
description: Next + NextAuth + Password è®¤è¯
badges: å®è·µ
tags: Next,NextAuth,Prisma
publicAt: "2022-12-11"
---

æ¥ç€ä¸Šä¸€ç¯‡æ•™ç¨‹çš„ä»£ç ï¼Œæˆ‘ä»¬æ¥å®ç°é‚®ç®±å¯†ç ç™»å½•ï¼Œè¿™é‡ŒèƒŒåä¾ç„¶æ˜¯ä½¿ç”¨ NextAuth çš„èº«ä»½ç­¾å‘ï¼Œåªä¸è¿‡æˆ‘ä»¬è¦è‡ªå®šä¹‰è®¤è¯é€»è¾‘ï¼Œok å¼€å§‹å§ï¼

### æ–°å¢å¯†ç å­—æ®µ

æ—¢ç„¶æ˜¯å¯†ç ç™»å½•ï¼Œæˆ‘ä»¬å°±éœ€è¦å­˜å‚¨ç”¨æˆ·çš„å¯†ç 

1. æ–°å¢å¯†ç å­—æ®µ
   `/prisma/schema.prisma`

```text
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime? @updatedAt @map("updated_at")

  accounts Account[]
  sessions Session[]
  Post     Post[]

  @@map("users")
}
```

åœ¨ Userï¼ˆæ•°æ®åº“è¡¨ä¸º usersï¼‰ ä¸‹æ–°å¢ `password` å­—æ®µï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯ psql æ•°æ®åº“ï¼Œç±»å‹ç›´æ¥ä½¿ç”¨ `String` ï¼Œå¦‚æœæ˜¯ MySQL çš„è¯ï¼Œéœ€è¦ä½¿ç”¨ `@db.Text` ç±»å‹

2. æ›´æ–°æ•°æ®åº“

```shell
npx prisma migrate dev --name password
```

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211090428.png)

å¯ä»¥çœ‹åˆ°å·²ç»æœ‰ `password` å­—æ®µäº†

3. ç”Ÿæˆ Prisma Client Typescript ç±»å‹

```shell
npx prisma generate
```

å¦‚æœä½ ä½¿ç”¨ vscode ä¹‹åå¼€å‘ä¾ç„¶æ²¡æœ‰ `User.password` æç¤ºçš„è¯ï¼Œå¯ä»¥æ‰“å¼€ vscode æ§åˆ¶å‘½ä»¤ `Shift + Command + p` æ‰“å¼€ï¼Œè¾“å…¥ `Reload webviews` å›è½¦ï¼Œå³å¯é‡å¯å½“å‰è§†å›¾

### å¯†ç ç¼–ç ä¸è§£ç 

åŠ å¯†æ–¹å¼è¿™é‡Œé€‰æ‹© `bcrypt` è¿™ä¸éœ€è¦ä¿å­˜ `salt` æ›´å®‰å…¨äº›ï¼Œç¼–ç å¤„ç†åº“é€‰æ‹© [bcrypt.js](https://github.com/dcodeIO/bcrypt.js) è¿™æ˜¯ä¸€ä¸ª js å®ç°çš„å¤„ç†åº“ï¼Œæ²¡æœ‰é€‰æ‹© c++ å®ç°çš„ [node bcrypt](https://github.com/kelektiv/node.bcrypt.js) æ˜¯å› ä¸ºå®ƒåœ¨å®‰è£…çš„æ—¶å€™ä»¥æ¥å®¹æ˜“æŠ¥é”™ ğŸ«£ï¼ˆç¯å¢ƒé—®é¢˜ï¼‰

1. å®‰è£…ä¾èµ–

```shell
pnpm add bcryptjs
pnpm add -D @types/bcryptjs
```

2. åŠ å¯†å’Œè§£å¯†
   `/lib/utils.ts`

```ts
import bcrypt from "bcryptjs";

// å°†æ˜æ–‡å¤„ç†ä¸º hash
export function hashPassword(password: string) {
  return bcrypt.hashSync(password, 10);
}

// å¯¹æ¯”æ˜æ–‡å’Œ hash æ˜¯å¦ä¸€è‡´
export function comparePassword(password: string, hashPassword: string) {
  return bcrypt.compareSync(password, hashPassword);
}
```

è¿™ä¸¤ä¸ªå‡½æ•°æ˜¯åŒæ­¥çš„ï¼Œå…·ä½“äº†è§£å¯ä»¥å‚è€ƒæ–‡æ¡£ [bcrypt.js - Usage Sync](https://github.com/dcodeIO/bcrypt.js#usage---sync)

### å¯†ç ç™»å½•é€»è¾‘

åŸºç¡€å·¥ä½œå¥½äº†ï¼Œæˆ‘ä»¬æ¥æ•´ç†ä¸‹å¯†ç ç™»å½•çš„é€»è¾‘

1. åœ¨ç”¨æˆ·å·²ç»è®¾ç½®äº†å¯†ç çš„æƒ…å†µä¸‹ï¼Œæ‰å¯ä½¿ç”¨å¯†ç ç™»å½•ã€‚
2. æœªè®¾ç½®å¯†ç çš„ç”¨æˆ·ç™»å½•ï¼ˆGithub æˆ– Emailï¼‰åï¼Œä¼šå¼¹å‡ºå¯†ç è®¾ç½®æç¤ºï¼Œå®Œæˆå¯†ç è®¾ç½®åæ‰å¯è¿›è¡Œï¼ˆå¼ºåˆ¶ ğŸ¤” å½“ç„¶è¿™ä¹Ÿå¯ä¸å¼ºåˆ¶ï¼Œå–å†³äºä½ ï¼‰å…¶ä»–æ“ä½œã€‚
3. å·²è®¾ç½®å¯†ç çš„ç”¨æˆ·ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„æ–¹å¼ç™»å½•ï¼Œä¸”ç™»å½•åä¸ä¼šæœ‰å¯†ç è®¾ç½®æç¤ºã€‚

### å¯†ç éªŒè¯

å®ç° NextAuth ä¸­è‡ªå®šä¹‰é€»è¾‘éªŒè¯
`/pages/api/auth/[...nextauth].ts`

```ts
import { NextApiHandler } from "next";
import { NextAuthOptions } from "next-auth";
import { PrismaAdapter } from "@next-auth/prisma-adapter";
import GitHubProvider from "next-auth/providers/github";
import EmailProvider from "next-auth/providers/email";
import CredentialsProvider from "next-auth/providers/credentials";
import NextAuth from "next-auth/next";
import { db } from "~/lib/db/prisma";
import { comparePassword } from "~/lib/utils";

export const authOptions: NextAuthOptions = {
  adapter: PrismaAdapter(db),
  secret: process.env.SECRET,
  session: {
    // Set to jwt in order to CredentialsProvider works properly
    strategy: "jwt",
  },
  providers: [
    GitHubProvider({
      clientId: process.env.GITHUB_ID,
      clientSecret: process.env.GITHUB_SECRET,
    }),
    EmailProvider({
      server: {
        host: process.env.EMAIL_SERVER_HOST,
        port: process.env.EMAIL_SERVER_PORT,
        auth: {
          user: process.env.EMAIL_SERVER_USER,
          pass: process.env.EMAIL_SERVER_PASSWORD,
        },
      },
      from: process.env.EMAIL_FROM,
    }),
    CredentialsProvider({
      id: "emailPassword",
      name: "Password",
      credentials: {
        email: { label: "Email", type: "email", placeholder: "Email" },
        password: {
          label: "Password",
          type: "password",
          placeholder: "Password",
        },
      },
      async authorize(credentials) {
        try {
          const { email, password } = credentials;
          if (!email || !password) {
            throw new Error("email and password are required");
          }
          const user = await db.user.findUnique({
            where: { email },
          });
          // ç”¨æˆ·ä¸å­˜åœ¨
          if (!user) {
            throw new Error("Incorrect email or password");
          }
          // ç”¨æˆ·æœªè®¾ç½®å¯†ç 
          if (!user.password) {
            throw new Error(
              "Account not init password, Please use email verification"
            );
          }
          // å¯†ç ä¸æ­£ç¡®
          if (!comparePassword(password, user.password)) {
            throw new Error("Incorrect email or password");
          }

          return {
            id: user.id,
            name: user.name,
            email: user.email,
          };
        } catch (err) {
          console.log(err?.message);

          return null;
        }
      },
    }),
  ],
};

const authHandler: NextApiHandler = (req, res) =>
  NextAuth(req, res, authOptions);

export default authHandler;
```

- `CredentialsProvider` è¿™æ˜¯ NextAuth æä¾›çš„è‡ªå®šä¹‰è®¤è¯åŒ…è£…å™¨
- `id` å’Œ `name` æ˜¯ä¸å¯å°‘çš„ï¼Œ`id` æ˜¯åŒ…è£…å™¨çš„å”¯ä¸€æ ‡è¯†ï¼Œ`name` æ˜¯åŒ…è£…å™¨æ˜¾ç¤ºçš„åç§°
- `credentials` ç”¨æ¥è®¾ç½®è®¤è¯é¡¹ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ç”¨æˆ·è¾“å…¥ `email` å’Œ `password`ï¼ŒNextAuth å°†ç”Ÿæˆä¸¤ä¸ªè¾“å…¥æ¡†æ¥è¾“å…¥ç›¸åº”çš„ä¿¡æ¯
- `authorize` è®¤è¯çš„æ ¸å¿ƒï¼Œæ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œç¨åè¯¦ç»†è®²è§£
- `session.strategy` å¯ä»¥çœ‹åˆ°è¿™é‡Œä¹Ÿæ”¹å˜äº† session çš„å­˜å‚¨ç­–ç•¥ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä½¿ç”¨äº†æ•°æ®åº“è®¤è¯çš„æƒ…å†µä¸‹ï¼Œ`CredentialsProvider` è®¤è¯çš„ä¿¡æ¯æœªä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œå°±åªèƒ½ä½¿ç”¨ jwt çš„æ–¹å¼åšç­¾å‘ï¼Œä½†è¿™é‡Œä¹Ÿå°±éœ€è¦è¿™ä¸€ä¸ªé…ç½®å°±å¥½ï¼Œæ— éœ€å…¶ä»–è°ƒæ•´ï¼ˆ[å‚è€ƒ](https://next-auth.js.org/configuration/providers/credentials)ï¼‰

#### `authorize`

```ts
authorize: (
  credentials: Record<keyof C, string> | undefined,
  req: Pick<RequestInternal, "body" | "query" | "headers" | "method">
) => Awaitable<User | null>;
```

è¿™æ˜¯ `authorize` çš„ç±»å‹

- `credentials` è®¤è¯ä¿¡æ¯ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯ä¸Šé¢ `credentials` è¡¨å•é‡Œçš„ `email` å’Œ `password`
- `req` è¯·æ±‚
- `Awaitable<User | null>` æ¥å—å¼‚æ­¥çš„å“åº”ï¼Œå½“è¿”å› `null` åˆ™è®¤è¯å¤±è´¥ï¼Œè¿”å› `User` å¯¹è±¡è®¤è¯æˆåŠŸï¼Œè¿™é‡Œå¦‚æœä¸­é€”æ‰§è¡Œæœ‰ `Error` æœªè¢«å¤„ç†ï¼Œåˆ™ä¼šè·³è½¬åˆ° NextAuth çš„ Error é¡µé¢

è¿™é‡Œæœ‰ç‚¹è¦æ³¨æ„çš„å°±æ˜¯ï¼Œè™½ç„¶ä¸Šé¢æˆ‘å†™äº† `throw new Error(...)` ä½†è¿™äº›ä¿¡æ¯è¢«æ•è·åï¼Œä»…ä»…æ˜¯æ‰“å°å‡ºæ¥äº†ï¼Œä¸éœ€è¦æŠ›åˆ° NextAuth å±‚é¢ï¼ŒåŸå› æ˜¯åœ¨ NextAuth è‡ªå¸¦çš„é¡µé¢ä¸­ï¼Œè‡ªå®šä¹‰åˆ¤æ–­é€»è¾‘é”™è¯¯ä¸ä¼šè¢«è®¤ä¸ºæ˜¯æŸäº›éªŒè¯é”™è¯¯ï¼Œè€Œæ˜¯ç›´æ¥è®¤ä¸ºæ˜¯ç¨‹åºé”™è¯¯ï¼Œå°±è·‘åˆ° Error é¡µé¢äº† ğŸ˜“ï¼Œè¿™é‡Œé”™è¯¯çš„è¯ï¼Œä»…å¯ä»¥è¿”å› `null`ï¼Œå¦‚æœè¦æ›´å…¨é¢çš„è‡ªå®šä¹‰é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘çš„å»ºè®®æ˜¯è‡ªå®šä¹‰é¡µé¢å§ï¼ˆä¸‹ä¸€ç¯‡æ–‡ç« å‡†å¤‡ ğŸ¤ªï¼‰

æ¥çœ‹çœ‹è®¾ç½®å®Œçš„æ•ˆæœ

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211100417.png)
![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211100429.png)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œ `Sign in with Password` å°±æ˜¯æˆ‘ä»¬æ–°åŠ çš„äº† `Password` è¿™å‡ ä¸ªæ–‡å­—å°±æ˜¯ `CredentialsProvider` é‡Œçš„ `name` è®¾ç½®çš„ã€‚è¿™é‡Œçš„é¡ºåº Github, Email, Email+Password ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ NextAuth Providers ä¸­çš„é…ç½®ä½ç½®ï¼ˆNextAuth å®é™…è¿™é‡Œç”¨äº†å¾ªç¯ç›´æ¥è·å– Providers [å±•ç¤º](https://next-auth.js.org/configuration/pages#oauth-sign-in)ï¼‰

è¾“å…¥ Emailï¼Œå¯†ç è¾“å…¥ä»»æ„å€¼

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211100908.png)
![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211100918.png)

å¯ä»¥çœ‹åˆ° url æºå¸¦äº†é”™è¯¯ä¿¡æ¯ï¼ˆå®é™…ä¸Š NextAuth å†…éƒ¨ä½¿ç”¨çš„é‡å®šå‘ï¼Œè¿™é‡Œè¡¨å•ä¹Ÿæ¸…ç©ºäº†ï¼‰æç¤ºä¿¡æ¯ä¹Ÿæ˜¯é»˜è®¤çš„ç™»å½•å¤±è´¥ä¿¡æ¯ï¼ˆä¸‹ä¸€ç¯‡è‡ªå®šä¹‰é¡µé¢æ¥ä¼˜åŒ–å§ï¼‰

è¿™é‡Œå¾ˆæ˜æ˜¾æ˜¯æˆ‘ä»¬çš„è¿™ä¸ªé‚®ç®±æ²¡æœ‰è®¾ç½®è¿‡å¯†ç ï¼Œé‚£ä¹ˆæ˜¯æ— æ³•ä½¿ç”¨å¯†ç ç™»å½•ã€‚

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211101241.png)

### æç¤ºç”¨æˆ·è®¾ç½®å¯†ç 

å…ˆä½¿ç”¨å…¶ä»–æ–¹å¼ç™»å½•è´¦å·ï¼Œä¹‹åå†æ¥è®¾ç½®å¯†ç 

1. å®ç°å¯†ç è®¾ç½®çš„æ¥å£
   `/pages/api/user/init-password.ts`

```ts
import { NextApiRequest, NextApiResponse } from "next";
import { unstable_getServerSession } from "next-auth";
import { db } from "~/lib/db/prisma";
import { hashPassword } from "~/lib/utils";
import { authOptions } from "../auth/[...nextauth]";

export default async function (req: NextApiRequest, res: NextApiResponse) {
  if (req.method === "POST") {
    try {
      // å½“å‰ç™»å½•ç”¨æˆ·
      const { user } = await unstable_getServerSession(req, res, authOptions);
      if (!user) {
        throw new Error("Need Login");
      }
      const { password } = req.body;
      // å‚æ•°æ ¡éªŒ
      if (!password) {
        throw new Error("Invalid Password");
      }

      // è®¾ç½®å¯†ç 
      await db.user.update({
        where: { email: user.email },
        data: {
          password: hashPassword(password),
        },
      });

      return res.status(200).end();
    } catch (err) {
      console.log(err.message);

      return res.status(500).end();
    }
  } else {
    throw new Error(`The HTTP ${req.method} method is not supported`);
  }
}
```

- `unstable_getServerSession(req, res, authOptions)` è¿™æ˜¯ NextAuth æä¾›çš„æœåŠ¡ç«¯è·å– [Session](https://next-auth.js.org/configuration/nextjs#unstable_getserversession) çš„æ–¹æ³•ï¼Œç›®å‰è¿˜æœªå‘å¸ƒæ ‡å‡†ï¼Œä½†ä¹Ÿä»…æ˜¯åç»­å¯èƒ½ä¼šä¿®æ”¹æ¥å£åç§°çš„äº‹æƒ…ï¼Œä¸å½±å“æˆ‘ä»¬ä½¿ç”¨ï¼Œ è¿™é‡Œ `authOptions` æ˜¯å¿…é¡»çš„ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ `nextauth` é…ç½®æ–‡ä»¶ä¸­çš„ `options` å°±å¥½ã€‚

2. è·å–æ˜¯å¦å·²è®¾ç½®å¯†ç 
   å¦‚ä½•çŸ¥é“ç”¨æˆ·æ˜¯å¦è®¾ç½®äº†å¯†ç ï¼Ÿéš¾é“éœ€è¦ä¸€ä¸ªæ¥å£å»æŸ¥è¯¢å˜›ï¼Ÿå¤ªéº»çƒ¦äº†å§ï¼å¯ä»¥ç›´æ¥ç”¨ session å–åˆ°çš„è¯ï¼Œå¤šæ–¹ä¾¿å•Šï¼

`/pages/api/auth/[...nextauth].ts`

```ts
//...

export const authOptions: NextAuthOptions = {
  // ...
  callbacks: {
    async session({ session }) {
      const user = await db.user.findUnique({
        where: { email: session.user.email },
      });

      if (user) {
        session.user.noPwd = !user.password;
      }

      return session;
    },
  },
};
```

- `callbacks` æ˜¯ Provider è®¤è¯å®Œçš„å›è°ƒï¼Œæˆ‘ä»¬è¿™é‡Œé‡æ–°ä¿®æ”¹äº† session çš„æ•°æ®ï¼ˆ[æ–‡æ¡£](https://next-auth.js.org/configuration/callbacks)ï¼‰

ğŸ¤– å®é™…è¿™é‡Œæ•°æ®åº“çš„æŸ¥è¯¢ï¼Œæ›´å¥½çš„å†™æ³•æ˜¯åœ¨ jwt ä¸­ï¼ˆå› ä¸ºæˆ‘ä»¬ä¸Šé¢ä¿®æ”¹äº† `session.strategy` ä¸º jwt ï¼‰åŸå› æ˜¯ jwt æ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œåœ¨è¿‡æœŸå‰ï¼Œä¸ç”¨æ¯æ¬¡æ‰§è¡Œï¼ˆå‡å°‘æŸ¥è¯¢æ•°æ®åº“æ¬¡æ•°ï¼‰

```ts
callbacks: {
    async session({ token, session }) {
      if (token) {
        session.user = {
          ...session.user,
          id: user.id,
          name: user.name,
          email: user.email,
          noPwd: user.noPwd,
        }
      }

      return session
    },
    async jwt({ token, user }) {
      const dbUser = await db.user.findUnique({
        where: {
          email: token.email,
        },
      })

      if (!dbUser) {
        token.id = Number(user.id)
        return token
      }

      return {
        ...token,
        id: user.id,
        name: user.name,
        email: user.email,
        picture: dbUser.image,
        noPwd: !dbUser.password
      }
    },
},
```

è®¿é—®ï¼š http://localhost:3000/api/auth/session

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211102449.png)

ç±»å‹é”™è¯¯çš„é—®é¢˜ï¼ŒNextAuth `User` ä¸­æ²¡æœ‰ `noPwd` ç±»å‹ï¼
`/types/next-auth.d.ts`

```ts
import NextAuth, { DefaultSession } from "next-auth";

declare module "next-auth" {
  /**
   * Returned by `useSession`, `getSession` and received as a prop on the `SessionProvider` React Context
   */
  interface Session {
    user: {
      /** The user's postal address. */
      noPwd?: boolean;
    } & DefaultSession["user"];
  }
}
```

3. æ²¡æœ‰è®¾ç½®å¯†ç å°±å±•ç¤ºå¼¹çª—
   æˆ‘ä»¬å¸Œæœ›åœ¨é™¤äº†è®¤è¯å¤–çš„é¡µé¢ï¼Œå½“ç”¨æˆ·ç™»å½•åï¼Œéƒ½åœ¨æ²¡è®¾ç½®å¯†ç çš„æƒ…å†µä¸‹æ˜¾ç¤ºå¼¹çª—ï¼Œè¿™é‡Œæœ€å¥½çš„æ–¹å¼åœ¨æ”¾åœ¨å½“å‰çš„ `Layout` ç»„ä»¶é‡Œï¼ˆæ”¾åœ¨ `_app` æˆ– `_document` éƒ½æ²¡å¿…è¦ï¼Œæ¯•ç«Ÿæœ‰äº›é¡µé¢ä¸éœ€è¦è¿™ä¸ªåˆ¤æ–­ï¼Œä¾‹å¦‚ï¼šç™»å½•ï¼‰ï¼Œå¦‚æœæ„¿æ„çš„è¯ï¼Œè¿˜å¯ä»¥ç‹¬ç«‹å°è£…ä¸€ä¸ª `NeedInitPasswordWrapper` çš„ç»„ä»¶

`/components/Layouts.tsx`

```tsx
import { useSession } from "next-auth/react";
import React, { ReactNode, useEffect } from "react";
import refreshSession from "~/lib/utils";
import Header from "./Header";

const Layout: React.FC<{ children?: ReactNode }> = (props) => {
  const { data, status } = useSession();

  const handleSubmitInitPassword = async () => {
    let password = "";
    // while å¾ªç¯æ—¶å¼ºåˆ¶ç”¨æˆ·è¾“å…¥å¯†ç ï¼Œä¸è¦å¼ºåˆ¶çš„è¯ï¼Œå¯ä»¥å»æ‰
    do {
      password = window.prompt("Please enter your init password", "");
    } while (!password || password.trim() === "");
    try {
      // ä¿å­˜å¯†ç 
      const res = await fetch("/api/user/init-password", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          password,
        }),
      });
      if (res.ok) {
        window.alert("Init password save successful");
      }
    } catch (err) {
      console.log(err);
    } finally {
      // åˆ·æ–°å®¢æˆ·ç«¯ session
      refreshSession();
    }
  };

  // å®¢æˆ·ç«¯æ‰æ‰§è¡Œ
  useEffect(() => {
    // ç”¨æˆ·å·²ç™»å½•ï¼Œä¸”æ²¡è®¾ç½®å¯†ç 
    if (status === "authenticated" && data?.user?.noPwd) {
      handleSubmitInitPassword();
    }
    // çŠ¶æ€å˜åŒ–æ—¶ï¼Œé‡æ–°åˆ¤æ–­
  }, [status]);

  return (
    <div>
      <Header />
      <div className="px-8">{props.children}</div>
    </div>
  );
};

export default Layout;
```

`/lib/utils.ts`

```ts
// only client
export default function refreshSession() {
  const event = new Event("visibilitychange");
  document.dispatchEvent(event);
}
```

è¿™é‡Œé€»è¾‘æœ¬èº«æ²¡ä»€ä¹ˆï¼Œè¦æ³¨æ„çš„æ˜¯

- `session stauts` çš„æ”¹å˜ï¼Œè¦é‡æ–°è§¦å‘åˆ¤æ–­ï¼Œå¦åˆ™å¤„èŠ‚ç‚¹æŒ‚è½½æ—¶å¯èƒ½çŠ¶æ€æ˜¯ `loading` ä¹‹åæ‰å˜ä¸º `authenticated`
- `refreshSession` å‡½æ•°æ˜¯ä¸ºäº†å¼ºåˆ¶åˆ·æ–°å®¢æˆ·ç«¯ `session` ä¿¡æ¯ï¼ŒNextAuth æ²¡æœ‰æä¾›åˆ·æ–° Session çš„å·¥å…·ï¼Œä½†ä¼šç›‘æ§çª—å£çš„æ˜¾ç¤ºæ¿€æ´»äº‹ä»¶ï¼Œé‡æ–°è¯·æ±‚ sessionï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¼ºåˆ¶è§¦å‘è¯¥äº‹ä»¶å³å¯ï¼Œå¦åˆ™é€šå¸¸è®¾ç½®æˆåŠŸå¯†ç äº†ï¼Œä½† session ä¸­ä¾ç„¶æ˜¾ç¤ºæ²¡è®¾ç½®å¯†ç ã€‚

okï¼Œæ­¤æ—¶æˆ‘ä»¬æ‰“å¼€é¡µé¢ï¼Œç™»å½•çŠ¶æ€ä¸‹åˆ·æ–°

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211104824.png)

è¿™é‡Œæœ‰å¾ªç¯ä¸ºç©ºåˆ¤æ–­ï¼Œæ‰€ä»¥å–æ¶ˆæ²¡ç”¨ï¼Œä¹–ä¹–è¾“å…¥å§ï¼

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211104947.png)
![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211105002.png)
![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211105019.png)

ok, é€€å‡ºç™»å½•ï¼Œä½¿ç”¨å¯†ç ç™»å½•æ¥è¯•è¯•

![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211105054.png)
![Next NextAuth Password](/static/images/next-auth-password-tutorial/20221211105105.png)

ğŸ¤™ æˆåŠŸå•¦

- æºç ï¼šhttps://github.com/hehehai/next-auth-prisma/tree/auth-by-password

è¿™æ˜¯ä¸€ä¸ªæ•™ç¨‹æ¡ˆä¾‹ï¼Œæ›´å¤šçš„éªŒè¯ï¼ŒUI ç­‰ä¼˜åŒ–å¤§å®¶æ ¹æ®éœ€è¦è‡ªå·±å¤„ç†å§ã€‚
