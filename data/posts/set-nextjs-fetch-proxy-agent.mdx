---
title: ä¸º Nextjs fetch è®¾ç½®è¯·æ±‚ä»£ç†
description: å›½å†…å¼€å‘è€…ï¼Œåœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼ˆå¦‚æœåŠ¡åœ¨å›½å†…ï¼Œéœ€è¦å‘é€ GPT è¯·æ±‚ï¼Œæˆ–åœ¨æœ¬åœ°å¼€å‘æ—¶ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸º Fetch è®¾ç½®ä»£ç†ã€‚
tags: NextJS,NodeJS,Fetch,Proxy
badges: å®è·µ
publicAt: "2024-02-18"
---

[Nextjs 13](https://nextjs.org/docs/app/api-reference/functions/fetch) ç‰ˆæœ¬åä¸ºæ•´ä¸ªæœåŠ¡æ‰©å±•äº† [Web Fetch API](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)ï¼Œåœ¨ä¹‹å‰ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨æœåŠ¡ç«¯ä½¿ç”¨ Fetch æ¥å‘é€è¯·æ±‚ï¼Œåªèƒ½å€ŸåŠ©ä¸€äº›ç¬¬ä¸‰æ–¹åº“å®ç°ç±»å‹çš„åŠŸèƒ½ï¼Œå¦‚ [axios](https://github.com/axios/axios)ï¼Œ[node-fetch](https://github.com/node-fetch/node-fetch), [got](https://github.com/sindresorhus/got)ã€‚

å›½å†…å¼€å‘è€…ï¼Œåœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸‹ï¼ˆå¦‚æœåŠ¡åœ¨å›½å†…ï¼Œéœ€è¦å‘é€ GPT è¯·æ±‚ï¼Œæˆ–åœ¨æœ¬åœ°å¼€å‘æ—¶ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸º Fetch è®¾ç½®ä»£ç†ã€‚

## Fetch VS XHR

`Fetch API` å’Œ `XMLHttpRequest`ï¼ˆXHRï¼‰æ˜¯ç”¨äºåœ¨ Web åº”ç”¨ç¨‹åºä¸­å‘èµ·ç½‘ç»œè¯·æ±‚çš„ä¸¤ç§ä¸åŒçš„æŠ€æœ¯ã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **ä½¿ç”¨æ–¹å¼**ï¼š`Fetch API` åŸºäº `Promise`ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€æ´å’Œå‹å¥½ï¼Œè€Œ `XMLHttpRequest` åˆ™åŸºäºäº‹ä»¶æœºåˆ¶å®ç°è¯·æ±‚æˆåŠŸä¸å¤±è´¥çš„å›è°ƒï¼Œä½¿ç”¨èµ·æ¥ç›¸å¯¹ç¹çå’Œæ··ä¹±ã€‚
2. **API è®¾è®¡**ï¼š`Fetch API` é‡‡ç”¨äº†æ¨¡å—åŒ–è®¾è®¡ï¼ŒAPI åˆ†æ•£åœ¨å¤šä¸ªå¯¹è±¡ä¸Šï¼ˆå¦‚ `Response` å¯¹è±¡ã€`Request` å¯¹è±¡ã€`Headers` å¯¹è±¡ï¼‰ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œ`XMLHttpRequest` çš„ API è®¾è®¡å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œè¾“å…¥ã€è¾“å‡ºã€çŠ¶æ€éƒ½åœ¨åŒä¸€ä¸ªæ¥å£ç®¡ç†ã€‚
3. **åŠŸèƒ½ç‰¹æ€§**ï¼š`Fetch API` é€šè¿‡æ•°æ®æµï¼ˆ`Stream` å¯¹è±¡ï¼‰å¤„ç†æ•°æ®ï¼Œå¯ä»¥åˆ†å—è¯»å–ï¼Œæœ‰åˆ©äºæé«˜ç½‘ç«™æ€§èƒ½è¡¨ç°ï¼Œå‡å°‘å†…å­˜å ç”¨ï¼Œå¯¹äºè¯·æ±‚å¤§æ–‡ä»¶æˆ–ç½‘é€Ÿæ…¢çš„åœºæ™¯ç›¸å½“æœ‰ç”¨ã€‚è€Œ `XMLHttpRequest` å¯¹è±¡ä¸æ”¯æŒæ•°æ®æµï¼Œæ‰€æœ‰çš„æ•°æ®å¿…é¡»æ”¾åœ¨ç¼“å­˜é‡Œï¼Œä¸æ”¯æŒåˆ†å—è¯»å–ã€‚

æ€»çš„æ¥è¯´ï¼Œ`Fetch API` ç›¸å¯¹äº `XMLHttpRequest` å…·æœ‰æ›´åŠ ç°ä»£åŒ–çš„ç‰¹æ€§ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€æ´å’Œçµæ´»ï¼Œæ˜¯å½“å‰ Web åº”ç”¨ç¨‹åºä¸­æ¨èçš„ç½‘ç»œè¯·æ±‚æŠ€æœ¯ä¹‹ä¸€ã€‚

![Suport Web Fetch API](/static/images/set-nextjs-fetch-proxy-agent/support-web-fetch-api.png)

## Nodejs Fetch çš„ä»£ç†è®¾ç½®

Fetch Api åœ¨ `17.5.0` è¢«å®ç°ï¼ˆä½†ä¾ç„¶å¤„äº ğŸ§ª å®éªŒæ¨¡å¼ï¼‰ï¼Œ [Nodejs 18](https://nodejs.org/en/blog/announcements/v18-release-announce#new-globally-available-browser-compatible-apis) ç‰ˆæœ¬å¯ç›´æ¥ä½¿ç”¨ã€‚

`Fetch` çš„å®ç°æ¥è‡ª `undici`ï¼Œå¹¶å—åˆ°æœ€åˆåŸºäº `undici-fetch` çš„ `node-fetch` çš„å¯å‘ã€‚ Repo Pull Request [#41811](https://github.com/nodejs/node/pull/41811)

```js
const res = await fetch("https://nodejs.org/api/documentation.json");
if (res.ok) {
  const data = await res.json();
  console.log(data);
}
```

### ProxyAgent

`ProxyAgent` æ˜¯ `undici` åº“ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºè®¾ç½®ä»£ç†ã€‚é€šè¿‡ `ProxyAgent`ï¼Œ å¯ä»¥å°† HTTP æˆ– HTTPS è¯·æ±‚è·¯ç”±åˆ°æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨ã€‚è¿™åœ¨éœ€è¦é€šè¿‡ä»£ç†è®¿é—®å¤–éƒ¨èµ„æºçš„åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œæ¼”ç¤ºäº†å¦‚ä½•åœ¨ `undici` ä¸­ä½¿ç”¨ `ProxyAgent`ï¼š

```js
import { ProxyAgent, setGlobalDispatcher } from "undici";

const proxy = "http://username:password@ip:port";
const proxyAgent = new ProxyAgent(proxy);
setGlobalDispatcher(proxyAgent);
```

ç°åœ¨ï¼Œæ‰€æœ‰é€šè¿‡ `undici` å‘èµ·çš„è¯·æ±‚éƒ½ä¼šç»è¿‡æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨ã€‚

æˆ‘ä»¬é¦–å…ˆå¼•å…¥äº† `ProxyAgent` å’Œ `setGlobalDispatcher` æ¨¡å—ï¼Œ ç„¶ååˆ›å»ºäº†ä¸€ä¸ªä»£ç†å¯¹è±¡ `proxyAgent`ï¼Œå¹¶é€šè¿‡ `setGlobalDispatcher` å°†å…¶è®¾ç½®ä¸ºå…¨å±€çš„è°ƒåº¦å™¨ã€‚ æ‰€æœ‰é€šè¿‡ `undici` å‘èµ·çš„è¯·æ±‚éƒ½ä¼šç»è¿‡æŒ‡å®šçš„ä»£ç†æœåŠ¡å™¨ã€‚

<FAQBox title="setGlobalDispatcher æ˜¯ä»€ä¹ˆï¼Ÿ">
åœ¨ `undici` ä¸­ï¼Œ`setGlobalDispatcher` æ˜¯ç”¨æ¥è®¾ç½®å…¨å±€åˆ†å‘å™¨çš„ã€‚å…¨å±€åˆ†å‘å™¨æ˜¯ `undici` çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µï¼Œå®ƒç”¨äºæ§åˆ¶è¯·æ±‚çš„è°ƒåº¦å’Œå¤„ç†ã€‚é€šè¿‡ `setGlobalDispatcher`ï¼Œä½ å¯ä»¥è‡ªå®šä¹‰å…¨å±€åˆ†å‘å™¨çš„è¡Œä¸ºï¼Œä»¥æ»¡è¶³ç‰¹å®šçš„éœ€æ±‚ã€‚

è®¾ç½®å…¨å±€åˆ†å‘å™¨å¯ä»¥è®©ä½ å¯¹è¯·æ±‚çš„è°ƒåº¦å’Œå¤„ç†è¿›è¡Œæ›´ç²¾ç»†çš„æ§åˆ¶ï¼Œä¾‹å¦‚è‡ªå®šä¹‰è¿æ¥æ± ã€è¯·æ±‚é‡è¯•æœºåˆ¶ã€è¶…æ—¶å¤„ç†ç­‰ã€‚è¿™æ ·å¯ä»¥æ ¹æ®é¡¹ç›®çš„ç‰¹å®šéœ€æ±‚æ¥å®šåˆ¶åŒ–è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§å’Œæ€§èƒ½ã€‚

æ€»ä¹‹ï¼Œ`setGlobalDispatcher` æ˜¯ `undici` ä¸­ç”¨æ¥è®¾ç½®å…¨å±€åˆ†å‘å™¨çš„æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©ä½ å¯¹è¯·æ±‚çš„è°ƒåº¦å’Œå¤„ç†è¿›è¡Œå®šåˆ¶åŒ–é…ç½®ã€‚

å¦‚æœåªéœ€è¦ä¸ºæŸä¸ªè¯·æ±‚è®¾ç½®ä»£ç†ï¼Œå¯ä»¥ä¸º fetch è®¾ç½® `dispatcher`

</FAQBox>

```js
import { ProxyAgent, fetch } from "undici";

const proxy = "http://username:password@ip:port";
const proxyAgent = new ProxyAgent(proxy);

const response = await fetch("https://example.com", {
  dispatcher: proxyAgent,
});
```

åœ¨ `undici` ä¸­ï¼Œ`ProxyAgent` çš„å…¨éƒ¨å±æ€§åŒ…æ‹¬ï¼š

- `uri`ï¼šä»£ç†çš„ URL
- `token`ï¼šç”¨äºèº«ä»½éªŒè¯çš„å‡­æ®
- `timeout`ï¼šä»£ç†è¯·æ±‚çš„è¶…æ—¶æ—¶é—´
- `keepAlive`ï¼šæ˜¯å¦ä¿æŒä¸ä»£ç†æœåŠ¡å™¨çš„é•¿è¿æ¥
- `maxSockets`ï¼šä¸ä»£ç†æœåŠ¡å™¨å»ºç«‹çš„æœ€å¤§è¿æ¥æ•°
- `maxFreeSockets`ï¼šä¿æŒç©ºé—²çŠ¶æ€çš„æœ€å¤§è¿æ¥æ•°
- `maxCachedSessions`ï¼šæœ€å¤§ç¼“å­˜çš„ä¼šè¯æ•°

## Nextjs çš„ä»£ç†è®¾ç½®

Nextjs çš„ `Fetch` æ˜¯åŸºäº `undici` åšçš„å®ç°ï¼Œé‚£ä¹ˆå®ç°èµ·æ¥å°±å¾ˆç®€å•äº†

```js
import { ProxyAgent } from "undici";

export async function queryPost(context) {
  const proxyUrl = "http://username:password@ip:port"; // ä»£ç†çš„URL
  const response = await fetch("https://example.com", {
    agent: new ProxyAgent(proxyUrl), // ä½¿ç”¨ä»£ç†çš„URL
  });
  return response.json();
}
```

å¦‚æœè¦å…¨å±€ä»£ç†ï¼Œå¯ä»¥åœ¨ä¸»å…¥å£æ–‡ä»¶ App Route `layout.tsx` é‡Œè®¾ç½®

```js
import { ProxyAgent, setGlobalDispatcher } from "undici";

if (prcoess.env.LOCAL_FETCH_PROXY) {
  setGlobalDispatcher(new ProxyAgent(env.LOCAL_FETCH_PROXY));
}
```

## å‚è€ƒ

- [Nextjs Fetch](https://nextjs.org/docs/app/api-reference/functions/fetch)
- [Web Fetch API](https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API)
- [node-fetch](https://github.com/node-fetch/node-fetch)
- [undici](https://github.com/nodejs/undici)
- [Nodejs Fetch](https://nodejs.org/dist/latest-v18.x/docs/api/globals.html)
